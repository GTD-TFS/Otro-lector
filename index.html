<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FILIATRON</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#e6eefc; --accent:#4da3ff;
      --card:rgba(255,255,255,.08); --border:rgba(255,255,255,.18);
      --green:#22c57b; --red:#ff5656;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;font-family:system-ui,"Segoe UI",Arial;color:var(--fg);background:#0b1220}
    h1{margin:0 0 14px;font-size:20px}
    .grid{display:grid;gap:16px}
    .two{grid-template-columns:1fr}
    @media(min-width:900px){.two{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;backdrop-filter:blur(10px)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid var(--accent);color:var(--fg);background:rgba(77,163,255,.15);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.secondary{border-color:var(--border);background:rgba(255,255,255,.05)}
    .fields{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:760px){.fields{grid-template-columns:1fr 1fr}}
    label{font-size:12px;margin-bottom:4px;color:#cfe0ff}
    input,select{
      width:100%;padding:10px;border-radius:12px;background:rgba(10,16,28,.45);
      color:var(--fg);border:1px solid var(--border);outline:none;transition:border-color .15s
    }
    input.valid,select.valid{border-color:var(--green)!important}
    input.invalid,select.invalid{border-color:var(--red)!important}
    .span2{grid-column:1/-1}
    .mono{font-size:12px}
    .hint{font-size:12px;color:#bcd0f0}
  </style>
</head>
<body>
<h1>FILIATRON</h1>

<div class="grid two">
  <!-- ACCIONES -->
  <div class="card">
    <div class="row">
      <button class="btn" id="readAnalyze">Integrar</button>
      <button class="btn secondary" id="clear" title="Limpiar">üßπ</button>
    </div>
  </div>

  <!-- CAMPOS -->
  <div class="card">
    <div class="fields">
      <div><label>Nombre</label><input id="Nombre"></div>
      <div><label>Apellidos (MAY√öSCULAS)</label><input id="Apellidos"></div>
      <div><label>Tipo de documento</label><input id="Tipo"></div>
      <div><label>N¬∫ documento</label><input id="Numero"></div>
      <div><label>Sexo</label>
        <select id="Sexo"><option></option><option>MASCULINO</option><option>FEMENINO</option></select>
      </div>
      <div><label>Nacionalidad</label><input id="Nacionalidad"></div>
      <div class="span2"><label>Nombre de los Padres</label><input id="Padres"></div>
      <div><label>Fecha de nacimiento</label><input id="Nacimiento"></div>
      <div><label>Lugar de nacimiento</label><input id="Lugar"></div>
      <div class="span2"><label>Domicilio</label><input id="Domicilio"></div>
      <div><label>Tel√©fono</label><input id="Telefono" inputmode="numeric" pattern="[0-9 ]*"></div>
      <div><label>Condici√≥n (oblig.)</label>
        <select id="Condicion">
          <option></option><option>Requirente</option><option>Perjudicado</option>
          <option>Testigo</option><option>Identificado</option><option>Detenido</option>
        </select>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="download">Descargar JSON</button>
    </div>
  </div>
</div>

<script>
const toLines = (txt) => (txt || "")
  .split(/\r?\n/)
  .map(s => s.trim())
  .filter(s => s.length > 0);

const tcase = s => (s||"").toLowerCase().replace(/\b([A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±])/g,c=>c.toUpperCase());
const ucase = s => (s||"").toUpperCase();
const normalize = s => (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase();
const noSpace = s => normalize(s).replace(/\s+/g,'');

async function readFromClipboard(){
  try{
    const txt = await navigator.clipboard.readText();
    return txt || "";
  }catch{
    const m = prompt("Pega manualmente el OCR (texto bruto, l√≠nea por l√≠nea):");
    return m || "";
  }
}

function parseByRules(ocrRaw){
  // 1) Normalizaci√≥n para detecci√≥n: may√∫sculas sin tildes + SIN ESPACIOS (NS)
  const raw = ocrRaw || "";
  const lines = toLines(raw);
  const U = lines.map(normalize);
  const NS = noSpace(raw);

  // Encabezados (OCR-tolerantes) SIN ESPACIOS para detecci√≥n de rangos
  const RX_DOM_NS  = /D[O0Q]M[IL1N][C√áG][IL1][IL1][IO0Q]/; // DOMICILIO roto
  const RX_LNAC_NS = /L[U√úV][G6][A4]RDE?N[ A]*A?C[IM1][IM1][E3][MN][T7][O0]/; // LUGARDE/NACIMIENTO
  const RX_HIJO_NS = /H[IJ1][J1][OA0](?:\/[A@])?DE/; // HIJO(A)DE
  const RX_IDESP   = /I[DO]ESP/;

  // √çndices de encabezados por l√≠nea (comparando cada l√≠nea sin espacios)
  const findHeaderLine = (rxNS) => {
    for (let i=0;i<U.length;i++){
      if (rxNS.test(noSpace(U[i]))) return i;
    }
    return -1;
  };

  const idxDOM  = findHeaderLine(RX_DOM_NS);
  const idxLUG  = findHeaderLine(RX_LNAC_NS);
  const idxHIJO = findHeaderLine(RX_HIJO_NS);
  const idxEQUIPO = U.findIndex(s => s.trim() === 'EQUIPO');

  // 2) DOMICILIO por rango: desde DOM hasta LUGAR o EQUIPO
  let domicilio = "";
  if (idxDOM !== -1){
    const end = [idxLUG, idxEQUIPO].filter(i=>i>-1).sort((a,b)=>a-b)[0];
    const stop = (end !== undefined) ? end : lines.length;
    // unir todas las l√≠neas intermedias, cortando si aparece EQUIPO y su l√≠nea num√©rica debajo
    let parts = [];
    for (let i=idxDOM+1; i<stop; i++){
      const up = U[i];
      if (up === 'EQUIPO'){
        // si la siguiente l√≠nea es num√©rica/c√≥digo, saltarla tambi√©n y cortar domicilio
        const nxt = lines[i+1] || "";
        const nxtU = U[i+1] || "";
        const looksNumCode = /[0-9]/.test(nxt) || /^[A-Z0-9]{4,}$/.test(nxtU);
        if (looksNumCode) i++;
        break;
      }
      parts.push(lines[i]);
    }
    domicilio = parts.join(", ").trim();
  } else {
    // Sin encabezado DOMICILIO: heur√≠stica de calle y cortar donde empiece LUGAR o HIJO
    const looksAddr = s => /^(C\.|C\/|CALLE|AV(DA)?|AVENIDA|CTRA|CARRETERA|PLAZA|PZA|PASEO|PSO|CAMINO|CMNO|URB|VIA)\b/i.test(s||"");
    const start = lines.findIndex(looksAddr);
    if (start !== -1){
      const stop = [idxLUG, idxHIJO, idxEQUIPO].filter(i=>i>-1).sort((a,b)=>a-b)[0];
      let parts = [];
      for (let i=start; i<(stop ?? lines.length); i++){
        if (U[i] === 'EQUIPO'){
          const nxt = lines[i+1] || "";
          const nxtU = U[i+1] || "";
          const looksNumCode = /[0-9]/.test(nxt) || /^[A-Z0-9]{4,}$/.test(nxtU);
          if (looksNumCode) i++;
          break;
        }
        parts.push(lines[i]);
      }
      domicilio = parts.join(", ").trim();
    }
  }

  // 3) LUGAR DE NACIMIENTO: desde LUGAR hasta HIJO
  let lugarNac = "";
  if (idxLUG !== -1){
    const stop = (idxHIJO !== -1) ? idxHIJO : lines.length;
    const parts = [];
    for (let i=idxLUG+1; i<stop; i++){
      parts.push(lines[i]);
    }
    lugarNac = parts.join(", ").trim();
  }

  // 4) PADRES: desde HIJO/A DE hasta la primera l√≠nea que empiece por IDESP/IOESP
  let idxMRZ_L1_line = -1;
  for(let i=0;i<U.length;i++){
    if (/^I[DO]ESP/.test(U[i].replace(/\s+/g,''))) { idxMRZ_L1_line = i; break; }
  }
  let padres = "";
  if (idxHIJO !== -1){
    const stop = (idxMRZ_L1_line !== -1) ? idxMRZ_L1_line : lines.length;
    const parts = [];
    for (let i=idxHIJO+1; i<stop; i++){
      parts.push(lines[i]);
    }
    padres = parts.join(" ").replace(/\s*\/\s*/g," y ").trim();
    if (!/ y /i.test(padres)) {
      const arr = padres.split(/\s+/).filter(Boolean);
      padres = arr.length>=2 ? (arr[0] + " y " + arr.slice(1).join(" ")) : padres;
    }
  }

  // 5) MRZ: soportar separadores con '<<<<<<'
  function detectMRZ(upperLines){
    const isSeparator = (s)=> /^([<\s]){3,}$/.test((s||""));
    const clean = (s)=> (s||"").replace(/\s+/g,'').toUpperCase();
    const arr = upperLines.filter(s => s && s.trim() && !isSeparator(s));

    for(let i=0;i<arr.length;i++){
      const s = arr[i];
      if (/^I[DO]ESP/.test(s)){
        const l1 = clean(s), l2 = clean(arr[i+1]||""), l3 = clean(arr[i+2]||"");
        return [l1,l2,l3];
      }
    }
    const l2Pattern = /^([0-9A-Z]{2})([0-9A-Z]{2})([0-9A-Z]{2}).([MF])/;
    for(let j=0;j<arr.length;j++){
      const s = clean(arr[j]);
      if (l2Pattern.test(s)){
        const l1 = clean(arr[j-1]||""), l2 = s, l3 = clean(arr[j+1]||"");
        return [l1,l2,l3];
      }
    }
    const withAngles = arr.filter(s => (s||"").includes("<"));
    if (withAngles.length >= 3) return withAngles.slice(-3).map(clean);
    const last3Any = arr.slice(-3).map(clean);
    while (last3Any.length < 3) last3Any.unshift("");
    return last3Any;
  }
  const [MRZ_L1, MRZ_L2, MRZ_L3] = detectMRZ(U);

  // 6) Nacionalidad
  function isSpainFromL1(l1){
    const norm = l1.replace(/[1lƒ∞Ôº©]/g,'I').replace(/[5Ôº≥]/g,'S').replace(/[0ÔºØ]/g,'O');
    return /^I[DO]ESP/.test(norm);
  }
  let Nacionalidad = "";
  if (MRZ_L1 && isSpainFromL1(MRZ_L1)) Nacionalidad = "Espa√±a";
  if (!Nacionalidad && MRZ_L2 && MRZ_L2.includes("ESP")) Nacionalidad = "Espa√±a";

  // 7) N¬∫ documento: 9 previos a '<' con fallback 8 d√≠gitos + 1 letra en L1 si qued√≥ vac√≠o
  function docFromL1(l1, l2){
    const m = l1.match(/<{3,}/);
    if (m){
      const idx = m.index;
      if (idx >= 9) return l1.slice(idx-9, idx).toUpperCase();
    }
    if (l2 && /^(<|<+)/.test(l2)){
      const clean = l1.replace(/</g,'');
      if (clean.length >= 9) return clean.slice(-9).toUpperCase();
    }
    return "";
  }
  let numDoc = MRZ_L1 ? docFromL1(MRZ_L1, MRZ_L2) : "";
  if (!numDoc && MRZ_L1){
    const mAlt = MRZ_L1.match(/([0-9]{8}[A-Z])/);
    if (mAlt) numDoc = mAlt[1].toUpperCase();
  }

  // 8) Fecha (YYMMDD -> dd/mm/aaaa) y 9) Sexo desde L2
  let fechaNac = "", sexo = "";
  {
    const mapDigit = (ch)=>{
      if (/[0-9]/.test(ch)) return ch;
      const t = ch.toUpperCase();
      if (t==='O' || t==='Q') return '0';
      if (t==='I' || t==='L') return '1';
      if (t==='Z') return '2';
      if (t==='S') return '5';
      if (t==='B') return '8';
      return '0';
    };
    const m = MRZ_L2 ? MRZ_L2.match(/^([0-9A-Z]{2})([0-9A-Z]{2})([0-9A-Z]{2}).([MF])/) : null;
    if (m) {
      const yy = parseInt(mapDigit(m[1][0]) + mapDigit(m[1][1]),10);
      const mm = mapDigit(m[2][0]) + mapDigit(m[2][1]);
      const dd = mapDigit(m[3][0]) + mapDigit(m[3][1]);
      const year = yy >= 30 ? 1900 + yy : 2000 + yy;
      fechaNac = `${dd}/${mm}/${year}`;
      sexo = m[4] === "F" ? "FEMENINO" : "MASCULINO";
    }
  }

  // 10) Apellidos y Nombres desde L3 tras sexo
  let nombre = "", apellidos = "";
  if(MRZ_L3){
    const parts = MRZ_L3.split("<").filter(Boolean);
    const ap1 = parts[0] || "", ap2 = parts[1] || "";
    const nom1 = parts[2] || "", nom2 = parts[3] || "";
    apellidos = [ap1, ap2].filter(Boolean).join(" ").trim().toUpperCase();
    nombre = tcase([nom1, nom2].filter(Boolean).join(" ").trim());
  }

  // Tipo documento (por defecto)
  let tipo = "DNI";

  // --- Sanitizaci√≥n final ---
  // Encabezados a eliminar si vinieran pegados en la misma l√≠nea del valor
  const HEADER_RE = new RegExp(
    '^(?:'
      + 'D[O0Q]M[IL1N][C√áG][IL1][IL1][IO0Q]'
      + '|L[U√úV][G6][A4]R\\s*D[EE]?\\s*N[ A]*A?C[IM1][IM1][E3][MN][T7][O0]'
      + '|H[IJ1][J1][OA0](?:\\/[A@])?\\s*D[EE]'
    + ')[\\s:.-]*'
  , 'g');

  const sanitizeHeaderValue = (s)=>{
    if(!s) return '';
    const up = String(s).toUpperCase().replace(HEADER_RE, '');
    return up.replace(/^[\s:.,-]+|[\s:.,-]+$/g,'').replace(/\s{2,}/g,' ').trim();
  };

  // Quitar la palabra EQUIPO de cualquier valor
  const STRIP_EQUIPO_RE = /\bEQUIPO\b[:\s-]*/g;
  const stripEquipo = (s)=>{
    if(!s) return '';
    const up = String(s).toUpperCase().replace(STRIP_EQUIPO_RE, '');
    return up.replace(/^[\s:.,-]+|[\s:.,-]+$/g,'').replace(/\s{2,}/g,' ').trim();
  };

  domicilio    = tcase(stripEquipo(sanitizeHeaderValue(domicilio)));
  lugarNac     = tcase(stripEquipo(sanitizeHeaderValue(lugarNac)));
  padres       = tcase(stripEquipo(sanitizeHeaderValue(padres))).replace(/\sY\s/g, ' y ');
  nombre       = tcase(stripEquipo(nombre));
  apellidos    = stripEquipo(apellidos).toUpperCase();
  Nacionalidad = stripEquipo(Nacionalidad);
  tipo         = stripEquipo(tipo);
  fechaNac     = stripEquipo(fechaNac);
  sexo         = stripEquipo(sexo);
  if (numDoc)   numDoc = stripEquipo(numDoc);

  return {
    Nombre: nombre,
    Apellidos: apellidos,
    "Tipo de documento": tipo,
    "N¬∫ Documento": numDoc,
    Sexo: sexo,
    Nacionalidad: Nacionalidad,
    "Nombre de los Padres": padres,
    "Fecha de nacimiento": fechaNac,
    "Lugar de nacimiento": lugarNac,
    Domicilio: domicilio
  };
}

function validateAll(){
  ["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"]
    .forEach(id=>{
      const el=document.getElementById(id);
      const ok=!!(el.value&&el.value.trim());
      el.classList.toggle("valid",ok);
      el.classList.toggle("invalid",!ok);
    });
}
function updateFilename(){
  const ap=(document.getElementById('Apellidos').value||"APELLIDOS").trim();
  const el=document.getElementById('fname');
  if (el) el.textContent = ap + ".json";
}

function fillFormFromParsed(p){
  if(p.Nombre)  document.getElementById('Nombre').value = p.Nombre;
  if(p.Apellidos) document.getElementById('Apellidos').value = p.Apellidos;
  if(p["Tipo de documento"]) document.getElementById('Tipo').value = p["Tipo de documento"];
  if(p["N¬∫ Documento"]) document.getElementById('Numero').value = p["N¬∫ Documento"];
  if(p.Sexo) document.getElementById('Sexo').value = p.Sexo;
  if(p.Nacionalidad) document.getElementById('Nacionalidad').value = p.Nacionalidad;
  if(p["Nombre de los Padres"]) document.getElementById('Padres').value = p["Nombre de los Padres"];
  if(p["Fecha de nacimiento"]) document.getElementById('Nacimiento').value = p["Fecha de nacimiento"];
  if(p["Lugar de nacimiento"]) document.getElementById('Lugar').value = p["Lugar de nacimiento"];
  if(p.Domicilio) document.getElementById('Domicilio').value = p.Domicilio;
  updateFilename();
  validateAll();
}

function processOCR(ocr){
  if(!ocr.trim()){ alert("Portapapeles vac√≠o. Copia el OCR primero."); return; }
  const parsed = parseByRules(ocr);
  fillFormFromParsed(parsed);
}

document.getElementById('readAnalyze').addEventListener('click', async ()=>{
  const ocr = await readFromClipboard();
  processOCR(ocr);
});
document.getElementById('clear').addEventListener('click', ()=>{
  ["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"]
    .forEach(id=>document.getElementById(id).value="");
  updateFilename(); validateAll();
});
document.getElementById('Apellidos').addEventListener('input', updateFilename);

document.getElementById('download').addEventListener('click', ()=>{
  if(!document.getElementById('Condicion').value){
    alert("Condici√≥n obligatoria");
    document.getElementById('Condicion').classList.add('invalid');
    return;
  }
  const data={
    "Nombre": document.getElementById('Nombre').value,
    "Apellidos": (document.getElementById('Apellidos').value||"").toUpperCase(),
    "Tipo de documento": document.getElementById('Tipo').value,
    "N¬∫ Documento": document.getElementById('Numero').value,
    "Sexo": document.getElementById('Sexo').value,
    "Nacionalidad": document.getElementById('Nacionalidad').value,
    "Nombre de los Padres": document.getElementById('Padres').value,
    "Fecha de nacimiento": document.getElementById('Nacimiento').value,
    "Lugar de nacimiento": document.getElementById('Lugar').value,
    "Domicilio": document.getElementById('Domicilio').value,
    "Tel√©fono": document.getElementById('Telefono').value,
    "Condici√≥n": document.getElementById('Condicion').value
  };
  const fname=(document.getElementById('Apellidos').value||"APELLIDOS") + ".json";
  const a=document.createElement('a');
  a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data,null,2));
  a.download=fname; a.click();
});

updateFilename();
validateAll();
</script>

</body>
</html>
