<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Filiación · OCR → JSON (sin IA)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 16px; color: #111; background:#fff; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .grid { display: grid; gap: 14px; }
    .two { grid-template-columns: 1fr; }
    @media (min-width: 880px){ .two { grid-template-columns: 1fr 1fr; } }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; background:#fff; }
    .card h2{ font-size: 15px; margin:0 0 10px; }
    textarea { width: 100%; min-height: 32vh; padding: 10px; border-radius: 10px; border:1px solid #cbd5e1;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .btn { border: 1px solid #111; background:#111; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.secondary { background:#f5f5f5; color:#111; border-color:#cbd5e1; }
    .btn:active { transform: translateY(1px); }
    .fields { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width:720px){ .fields{ grid-template-columns: 1fr 1fr; } }
    label { display:block; font-size:12px; color:#374151; margin-bottom:6px; }
    input, select { width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    .span2 { grid-column: 1 / -1; }
    .muted { color:#6b7280; font-size:12px; }
    .ok { color:#065f46; }
    .warn { color:#92400e; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .footer { margin-top:10px; font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <h1>Filiación · Pegado OCR → Análisis y JSON</h1>

  <div class="grid two">
    <div class="card">
      <h2>1) Pegar OCR bruto (de Google Lens / Atajo iPhone)</h2>
      <textarea id="ocr" placeholder="Pega aquí el texto exacto que te devuelve Lens…"></textarea>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="analyze">Analizar OCR</button>
        <button class="btn secondary" id="clear">Limpiar</button>
        <span id="status" class="muted"></span>
      </div>
      <div class="footer">
        Reglas: cerco estricto para DNI (primer bloque &laquo;&laquo;&laquo;), MRZ para nombre/apellidos/sexo/fecha/nacionalidad, encabezados tolerantes (DOMICILIO, LUGAR DE NACIMIENTO, HIJO/A DE).
      </div>
    </div>

    <div class="card">
      <h2>2) Revisar / completar campos</h2>
      <div class="fields">
        <div>
          <label>Nombre</label>
          <input id="Nombre" />
        </div>
        <div>
          <label>Apellidos (MAYÚSCULAS)</label>
          <input id="Apellidos" />
        </div>
        <div>
          <label>Tipo de documento</label>
          <input id="Tipo" placeholder="DNI / NIE / PASAPORTE" />
        </div>
        <div>
          <label>Nº Documento</label>
          <input id="Numero" />
        </div>
        <div>
          <label>Sexo</label>
          <select id="Sexo">
            <option value=""></option>
            <option>MASCULINO</option>
            <option>FEMENINO</option>
          </select>
        </div>
        <div>
          <label>Nacionalidad</label>
          <input id="Nacionalidad" />
        </div>
        <div class="span2">
          <label>Nombre de los Padres (formato: Nombre1 y Nombre2)</label>
          <input id="Padres" />
        </div>
        <div>
          <label>Fecha de nacimiento (dd/mm/aaaa)</label>
          <input id="Nacimiento" placeholder="dd/mm/aaaa" />
        </div>
        <div>
          <label>Lugar de nacimiento</label>
          <input id="Lugar" />
        </div>
        <div class="span2">
          <label>Domicilio</label>
          <input id="Domicilio" />
        </div>
        <div>
          <label>Teléfono</label>
          <input id="Telefono" />
        </div>
        <div>
          <label>Condición</label>
          <input id="Condicion" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="download">Descargar JSON</button>
        <span class="muted">Se guardará como <span class="mono" id="fname">APELLIDOS.json</span></span>
      </div>
    </div>
  </div>

  <script>
    // Utilidades
    const titleCase = s => s
      .toLowerCase()
      .replace(/\b([A-Za-zÁÉÍÓÚÜÑáéíóúüñ]+)/g, w => w.charAt(0).toUpperCase() + w.slice(1));

    const onlyMRZ = s => s.toUpperCase().replace(/[^A-Z0-9<]/g,'');

    const collapseSpaces = s => s.replace(/\s+/g,' ').trim();

    // Detectores tolerantes de encabezados
    const isDomicilio = l => /DOMI|COMI/.test(l);
    const isNacimiento = l => /(LUGA|LIGAR|LUGOR).*(NACI|NADMI|NADIM)/.test(l) || /(NACI|NADMI|NADIM)/.test(l) && /(LUGA|LIGAR|LUGOR)/.test(l);
    const isPadres = l => /(HIJO\/A DE|HIIO\/A DE|HIJ0\/A DE|HUDIA DE|MADIA DE)/.test(l);
    const isEquipo = l => /EQUIPO/.test(l);

    // Checksum DNI
    const dniLetter = n => "TRWAGMYFPDXBNJZSQVHLCKE"[parseInt(n,10)%23];

    // Extraer MRZ (intentando recomponer si está partida)
    function extractMRZ(lines){
      const rawMRZ = lines.filter(l => /</.test(l));
      // L3: la última que lleva '<<'
      const L3 = (rawMRZ.slice().reverse().find(l=>l.includes("<<"))||"").toUpperCase().replace(/[^A-Z0-9<]/g,'');
      // L2: línea con fecha y sexo + país (buscar 6 dígitos + [MF] + país)
      const L2 = (rawMRZ.find(l => /[0-9]{6}.*[MF].*[A-Z]{3}/.test(l)) || "").toUpperCase().replace(/[^A-Z0-9<]/g,'');
      // L1: primera con bloque de cerco (<<) y número cerca
      let L1 = (rawMRZ.find(l => /<<</.test(l) || /<</.test(l)) || "").toUpperCase().replace(/[^A-Z0-9<]/g,'');
      // Si L1 quedó vacía, prueba a unir líneas contiguas
      if(!L1 && rawMRZ.length>=2){
        const j = rawMRZ.findIndex(l=>/<<</.test(l)||/<</.test(l));
        if(j>0){ L1 = onlyMRZ((rawMRZ[j-1]||"") + (rawMRZ[j]||"")); }
      }
      return {L1, L2, L3};
    }

    // DNI por primer cerco (estricto)
    function dniFromL1_CercoEstricto(L1){
      if(!L1) return "";
      // localizar primer bloque de '<' (al menos 2)
      const idx = L1.indexOf("<<") >= 0 ? L1.indexOf("<<") : L1.indexOf("<");
      if(idx <= 0) return "";
      // ventana estricta: 9 chars inmediatamente anteriores
      if(idx < 9) return "";
      const cand = L1.slice(idx-9, idx);
      if(!/^[0-9]{8}[A-Z]$/.test(cand)) return "";
      // validar letra
      const num = cand.slice(0,8), letter = cand.slice(-1);
      return dniLetter(num) === letter ? cand : "";
    }

    // Tipo de documento (conservador)
    function tipoDocumento(L1){
      if(/^ID.*ESP/.test(L1)) return "DNI";
      if(/^I.*ESP/.test(L1) && /[XYZ][0-9]{7}[A-Z]/.test(L1)) return "NIE";
      if(/^P</.test(L1)) return "PASAPORTE";
      return "";
    }

    // Nombre y apellidos desde L3
    function nombreApellidos(L3){
      if(!L3 || !L3.includes("<<")) return {nombre:"", apellidos:""};
      const i = L3.indexOf("<<");
      let ap_raw = L3.slice(0,i);
      let nom_raw = L3.slice(i+2);
      ap_raw = ap_raw.replace(/^<+|<+$/g,'').replace(/<+/g,' ').trim();
      nom_raw = nom_raw.replace(/^<+|<+$/g,'').replace(/<+/g,' ').trim();
      const apellidos = ap_raw.toUpperCase();
      const nombre = titleCase(nom_raw);
      return {nombre, apellidos};
    }

    // Fecha de nacimiento y sexo y nacionalidad desde L2
    function datosDesdeL2(L2){
      let fecha="", sexo="", nac="";
      if(L2){
        const m = L2.match(/([0-9]{2})([0-9]{2})([0-9]{2})/);
        if(m){
          const yy = parseInt(m[1],10), mm = m[2], dd = m[3];
          const year = (yy >= 30 ? 1900+yy : 2000+yy);
          fecha = `${dd}/${mm}/${year}`;
        }
        const sx = L2.match(/[MF]/);
        if(sx) sexo = sx[0] === "F" ? "FEMENINO" : "MASCULINO";
        const nat = (L2.match(/[A-Z]{3}(?=<{2,}|$)/g)||[]).pop() || "";
        nac = nat === "ESP" ? "España" : (nat || "");
      }
      return {fecha, sexo, nac};
    }

    // Bloques de texto OCR por encabezados tolerantes
    function extractBlocks(ocrText){
      const raw = ocrText.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(s=>s.length>0);
      const upper = raw.map(s=>s.toUpperCase());
      let domicilio="", nacimiento="", padres="";
      // indices de encabezados tolerantes
      const idxs = upper.map((l,idx)=>({l,idx}))
        .filter(o => isDomicilio(o.l)||isNacimiento(o.l)||isPadres(o.l)||isEquipo(o.l));
      function nextHeader(after){
        const n = idxs.find(o=>o.idx>after);
        return n ? n.idx : raw.length;
      }
      // DOMICILIO
      const dIdx = upper.findIndex(isDomicilio);
      if(dIdx>=0){
        const end = nextHeader(dIdx);
        domicilio = collapseSpaces(
          raw.slice(dIdx+1, end)
             .filter(s=>!/^\s*DNI\s*$/.test(s)) // ruido frecuente
             .join(', ')
        );
        domicilio = titleCase(domicilio);
      }
      // NACIMIENTO
      const nIdx = upper.findIndex(isNacimiento);
      if(nIdx>=0){
        const end = nextHeader(nIdx);
        nacimiento = collapseSpaces(raw.slice(nIdx+1, end).join(', '));
        nacimiento = titleCase(nacimiento);
      }
      // PADRES (toma la siguiente línea no vacía)
      const pIdx = upper.findIndex(isPadres);
      if(pIdx>=0){
        const next = raw.slice(pIdx+1).find(s=>s.trim().length>0) || "";
        if(next){
          const parts = next.split(/[\/,;]+/).map(s=>collapseSpaces(s));
          const p1 = parts[0] ? titleCase(parts[0]) : "";
          const p2 = parts[1] ? titleCase(parts[1]) : "";
          padres = (p1||p2) ? `${p1} y ${p2}`.trim() : "";
        }
      }
      return {raw, upper, domicilio, nacimiento, padres};
    }

    // Analizar OCR → campos
    document.getElementById('analyze').addEventListener('click', ()=>{
      const ocr = document.getElementById('ocr').value || "";
      if(!ocr.trim()){
        document.getElementById('status').textContent = "Pega el OCR primero.";
        return;
      }
      const {raw, upper, domicilio, nacimiento, padres} = extractBlocks(ocr);

      // MRZ
      const {L1, L2, L3} = extractMRZ(upper);
      const {nombre, apellidos} = nombreApellidos(L3);
      const {fecha, sexo, nac} = datosDesdeL2(L2);
      const numero = dniFromL1_CercoEstricto(L1);
      const tipo = tipoDocumento(L1);

      // Rellenar UI
      document.getElementById('Nombre').value = nombre;
      document.getElementById('Apellidos').value = apellidos;
      document.getElementById('Tipo').value = tipo;
      document.getElementById('Numero').value = numero;
      document.getElementById('Sexo').value = sexo;
      document.getElementById('Nacionalidad').value = nac;
      document.getElementById('Padres').value = padres;
      document.getElementById('Nacimiento').value = fecha;
      document.getElementById('Lugar').value = nacimiento;
      document.getElementById('Domicilio').value = domicilio;

      // Forzar formatos
      document.getElementById('Apellidos').value = document.getElementById('Apellidos').value.toUpperCase();
      if(document.getElementById('Nacionalidad').value === "ESP") document.getElementById('Nacionalidad').value = "España";

      // Nombre a Title Case (si viene en mayúsculas)
      const nomVal = document.getElementById('Nombre').value;
      if(nomVal) document.getElementById('Nombre').value = titleCase(nomVal);

      // Estado
      const st = [];
      st.push(L1 ? "MRZ L1 ✓" : "MRZ L1 ✗");
      st.push(L2 ? "L2 ✓" : "L2 ✗");
      st.push(L3 ? "L3 ✓" : "L3 ✗");
      st.push(numero ? "DNI ✓" : "DNI ✗");
      document.getElementById('status').innerHTML = st.map(s=>s.includes("✓")?`<span class="ok">${s}</span>`:`<span class="warn">${s}</span>`).join(" · ");
      updateFilename();
    });

    // Limpiar
    document.getElementById('clear').addEventListener('click', ()=>{
      document.getElementById('ocr').value = "";
      ["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"].forEach(id=>document.getElementById(id).value="");
      document.getElementById('status').textContent = "";
      updateFilename();
    });

    // Descargar JSON
    function currentJSON(){
      return {
        "Nombre": document.getElementById('Nombre').value || "",
        "Apellidos": (document.getElementById('Apellidos').value || "").toUpperCase(),
        "Tipo de documento": document.getElementById('Tipo').value || "",
        "Nº Documento": document.getElementById('Numero').value || "",
        "Sexo": document.getElementById('Sexo').value || "",
        "Nacionalidad": (document.getElementById('Nacionalidad').value === "ESP" ? "España" : document.getElementById('Nacionalidad').value || ""),
        "Nombre de los Padres": document.getElementById('Padres').value || "",
        "Fecha de nacimiento": document.getElementById('Nacimiento').value || "",
        "Lugar de nacimiento": document.getElementById('Lugar').value || "",
        "Domicilio": document.getElementById('Domicilio').value || "",
        "Teléfono": document.getElementById('Telefono').value || "",
        "Condición": document.getElementById('Condicion').value || ""
      };
    }

    function updateFilename(){
      const ap = (document.getElementById('Apellidos').value || "").trim().replace(/[\/\\]+/g,'-').replace(/\s+/g,' ');
      document.getElementById('fname').textContent = (ap ? ap : "APELLIDOS") + ".json";
    }

    document.getElementById('Apellidos').addEventListener('input', updateFilename);

    document.getElementById('download').addEventListener('click', ()=>{
      const data = JSON.stringify(currentJSON(), null, 2);
      const ap = (document.getElementById('Apellidos').value || "APELLIDOS").trim().replace(/[\/\\]+/g,'-').replace(/\s+/g,' ');
      const a = document.createElement('a');
      a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(data);
      a.download = `${ap}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  </script>
</body>
</html>
