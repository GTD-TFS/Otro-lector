<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DILIPOL · Filiación · OCR → JSON</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#e6eefc; --accent:#4da3ff;
      --card:rgba(255,255,255,.08); --border:rgba(255,255,255,.18);
      --green:#22c57b; --red:#ff5656;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;font-family:system-ui,"Segoe UI",Arial;color:var(--fg);background:#0b1220}
    h1{margin:0 0 14px;font-size:20px}
    .grid{display:grid;gap:16px}
    .two{grid-template-columns:1fr}
    @media(min-width:900px){.two{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;backdrop-filter:blur(10px)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid var(--accent);color:var(--fg);background:rgba(77,163,255,.15);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.secondary{border-color:var(--border);background:rgba(255,255,255,.05)}
    .fields{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:760px){.fields{grid-template-columns:1fr 1fr}}
    label{font-size:12px;margin-bottom:4px;color:#cfe0ff}
    input,select{
      width:100%;padding:10px;border-radius:12px;background:rgba(10,16,28,.45);
      color:var(--fg);border:1px solid var(--border);outline:none;transition:border-color .15s
    }
    /* bordes finos */
    input.valid,select.valid{border-color:var(--green)!important}
    input.invalid,select.invalid{border-color:var(--red)!important}
    .span2{grid-column:1/-1}
    .mono{font-size:12px}
    .hint{font-size:12px;color:#bcd0f0}
  </style>
</head>
<body>
<h1>DILIPOL · Filiación · OCR → JSON</h1>

<div class="grid two">
  <!-- ACCIONES -->
  <div class="card">
    <div class="row">
      <button class="btn" id="readAnalyze">Pegar del portapapeles y analizar</button>
      <button class="btn secondary" id="clear">Limpiar</button>
    </div>
    <div class="row hint">No se muestra el OCR. Se lee del portapapeles, se analiza y se rellenan los campos.</div>
  </div>

  <!-- CAMPOS -->
  <div class="card">
    <div class="fields">
      <div><label>Nombre</label><input id="Nombre"></div>
      <div><label>Apellidos (MAYÚSCULAS)</label><input id="Apellidos"></div>
      <div><label>Tipo de documento</label><input id="Tipo" placeholder="DNI / NIE / PASAPORTE"></div>
      <div><label>Nº documento</label><input id="Numero"></div>
      <div><label>Sexo</label>
        <select id="Sexo"><option></option><option>MASCULINO</option><option>FEMENINO</option></select>
      </div>
      <div><label>Nacionalidad</label><input id="Nacionalidad" placeholder="España / ESP / ..."></div>
      <div class="span2"><label>Nombre de los Padres (Nombre1 y Nombre2)</label><input id="Padres" placeholder="Juan y Victoria"></div>
      <div><label>Fecha de nacimiento</label><input id="Nacimiento" placeholder="dd/mm/aaaa"></div>
      <div><label>Lugar de nacimiento</label><input id="Lugar"></div>
      <div class="span2"><label>Domicilio</label><input id="Domicilio"></div>
      <div><label>Teléfono</label><input id="Telefono" inputmode="numeric" pattern="[0-9 ]*"></div>
      <div><label>Condición (oblig.)</label>
        <select id="Condicion">
          <option></option><option>Requirente</option><option>Perjudicado</option>
          <option>Testigo</option><option>Identificado</option><option>Detenido</option>
        </select>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="download">Descargar JSON</button>
      <span>→ <span class="mono" id="fname">APELLIDOS.json</span></span>
    </div>
  </div>
</div>

<script>
/* ================== Reglas y utilidades base (capitalización, limpieza) ================== */
const clean = s => (s||"").normalize("NFD").replace(/[^\x00-\x7FÀ-ÿ0-9 .,/()\-<]/g,'');
const collapse = s => (s||"").replace(/\s+/g,' ').trim();
const tcase = s => (s||"").toLowerCase().replace(/\b([A-Za-zÁÉÍÓÚÜÑáéíóúüñ])/g,c=>c.toUpperCase());

/* ================== MRZ ROBUSTO: normalización y extracción estricta ================== */
function normMRZ(s){
  return (s||"").toUpperCase()
    .replace(/[く‹«＜⟨⟪]/g,'<')          // variantes del símbolo '<'
    .replace(/[^A-Z0-9< \n]/g,' ')       // limpia basura
    .replace(/\s+/g,' ')
    .trim();
}
// L3 = último APELLIDOS<<NOMBRES
function mrzL3_strict(ocr){
  const txt = normMRZ(ocr);
  const re = /([A-Z]+(?:<[A-Z]+)*)<<([A-Z]+(?:<[A-Z]+)*)(?:<+|$)/g;
  let m,last=null; while((m=re.exec(txt))!==null){ last=m; }
  return last ? (last[1]+'<<'+last[2]).replace(/[^A-Z<]/g,'') : "";
}
// L1: “8 dígitos + letra” justo antes del primer “<<”
function mrzL1_strict(ocr){
  const txt = normMRZ(ocr);
  const m = txt.match(/([0-9]{8}[A-Z])<</);
  return m ? (m[1]+'<<') : "";
}
// L2: YYMMDD + Sexo + Nacionalidad
function mrzL2_strict(ocr){
  const txt = normMRZ(ocr);
  const m = txt.match(/([0-9]{2})([0-9]{2})([0-9]{2})([MF])[A-Z0-9<]*?([A-Z]{3})/);
  return m ? {yy:m[1],mm:m[2],dd:m[3],sx:m[4],nat:m[5]} : null;
}

/* ================== Reglas de campos desde MRZ ================== */
// DNI = exactamente 9 caracteres previos al primer “<<”: 8 dígitos + letra
function dniFromL1(L1){
  if(!L1) return "";
  const j=L1.indexOf("<<"); if(j<9) return "";
  const cand=L1.slice(j-9,j);
  return /^[0-9]{8}[A-Z]$/.test(cand) ? cand : "";
}
// Nombres/Apellidos desde L3. No filtrar apellidos duplicados válidos.
function namesFromL3(L3){
  if(!L3 || !L3.includes("<<")) return {nombre:"",apellidos:""};
  const i=L3.lastIndexOf("<<");
  let aps=L3.slice(0,i).replace(/<+/g,' ');
  let nom=L3.slice(i+2).replace(/<+/g,' ');
  // saneado
  aps = aps.replace(/[^A-Z ]+/g,' ').replace(/\s+/g,' ').trim();  // MAYÚSCULAS
  nom = nom.replace(/[^A-Z ]+/g,' ').replace(/\s+/g,' ').trim();  // TitleCase
  // evitar falsos apellidos como ESP / IDESP
  if(/^ESP(\s|$)/.test(aps) || /^IDESP/.test(aps)) aps="";
  // nombre no debe contener números ni tokens MRZ
  if(/\d/.test(nom) || /ESP/.test(nom)) nom="";
  return {nombre:tcase(nom), apellidos:aps.toUpperCase()};
}
// Fecha, sexo, nacionalidad desde L2. Siglo: aa>=30→19aa, aa<30→20aa
function dsFromL2(L2){
  if(!L2) return {fecha:"",sexo:"",nac:""};
  const yy=+L2.yy, mm=L2.mm, dd=L2.dd;
  const year = yy>=30 ? 1900+yy : 2000+yy;
  return {
    fecha: `${dd}/${mm}/${year}`,
    sexo: L2.sx==="F" ? "FEMENINO" : "MASCULINO",
    nac:  L2.nat==="ESP" ? "España" : L2.nat
  };
}

/* ================== Encabezados tolerantes (excesivos) ================== */
const HEAD = {
  domicilio: /(DOMI|COMI|D0MI|DOMIL|DOMIC|DIREC|CALLE|CL |AVDA|AVENID|VIA|URB|URBAN|CTRA|CARRE|CARRET|PZA|PLAZA|PORTAL|BLOQ|ESC|PLANTA|PISO|KM )/,
  nacimiento: /(L[UI]G[AO]R|LAGAR|LIGAR|LUGAR|LOCALID|CIUDAD|POBLAC|PROVIN).*(NAC|NACIM|NADIM)|LUGAR DE NAC|NACIMIENTO|LUGOR|LIGAR DE NAC/,
  padres: /(HIJ[O0]\/?A DE|H[I1]J[O0]\/?A DE|HIO\/?A DE|MADRE|PADRE|PROGEN|TUTOR|REPRES|PADRES)/
};
const isCodeToken = l => /^[A-Z0-9]{6,}$/.test((l||"").toUpperCase());
const looksAddr = l => /(AVDA|C\.|CALLE|PZA|PLAZA|CTRA|CARRE|URB|VIA)/.test((l||"").toUpperCase()) || /\b[0-9]{1,4}[A-Z]?\b/.test(l||"");
const isMRZLike = l => /<{2,}/.test((l||"").toUpperCase());

function domicilioFromOCR(ocr){
  const lines=clean(ocr).split('\n').map(s=>s.trim()).filter(Boolean);
  const U=lines.map(s=>s.toUpperCase());
  let idx = U.findIndex(l=>HEAD.domicilio.test(l));
  if(idx<0){
    const cand=lines.filter((l,i)=>looksAddr(U[i]));
    return cand.length ? tcase(collapse([...new Set(cand)].join(', '))) : "";
  }
  const out=[];
  for(let k=idx+1;k<lines.length;k++){
    const up=U[k];
    if(/EQUIPO/.test(up) || isMRZLike(up)) break;
    if(isCodeToken(up)) continue;
    if(!lines[k].trim()) continue;
    out.push(lines[k]); if(out.length>=4) break;
  }
  if(!out.length) return "";
  return tcase(collapse([...new Set(out.map(collapse))].join(', ')));
}
function lugarFromOCR(ocr){
  const lines=clean(ocr).split('\n').map(s=>s.trim()).filter(Boolean);
  const U=lines.map(s=>s.toUpperCase());
  const idx=U.findIndex(l=>HEAD.nacimiento.test(l));
  if(idx<0) return "";
  const take=[];
  for(let k=idx+1;k<lines.length;k++){
    const up=U[k];
    if(HEAD.domicilio.test(up) || /EQUIPO/.test(up) || isMRZLike(up)) break;
    if(isCodeToken(up)) continue;
    if(!lines[k].trim()) continue;
    take.push(lines[k]); if(take.length>=3) break;
  }
  if(!take.length) return "";
  return tcase(collapse([...new Set(take.map(collapse))].join(', ')));
}
function padresFromOCR(ocr){
  const lines=clean(ocr).split('\n').map(s=>s.trim()).filter(Boolean);
  const U=lines.map(s=>s.toUpperCase());
  const i=U.findIndex(l=>HEAD.padres.test(l));
  if(i<0) return "";
  const names=[];
  const inline=lines[i].replace(/.*?(HIJ[O0]\/?A DE|H[I1]J[O0]\/?A DE|HIO\/?A DE|MADRE|PADRE|PROGEN|TUTOR|REPRES|PADRES)\s*/i,'').trim();
  if(inline) names.push(inline);
  for(let k=i+1;k<i+3 && k<lines.length;k++){
    const up=U[k];
    if(HEAD.domicilio.test(up)||HEAD.nacimiento.test(up)||/EQUIPO/.test(up)||isMRZLike(up)||isCodeToken(up)) break;
    names.push(lines[k]);
  }
  const parts = collapse(names.join(' / ')).split(/[\/,;]+/).map(s=>collapse(s)).filter(Boolean).map(tcase);
  if(!parts.length) return "";
  if(parts.length===1) return parts[0]+" y";          // si solo hay uno
  return `${parts[0]} y ${parts[1]}`;
}

/* ================== Detección de TIPO si no hay DNI ================== */
function detectTipoFallback(ocr){
  const txt = normMRZ(ocr);
  // NIE: letra inicial X/Y/Z + 7 dígitos + letra
  if(/[XYZ][0-9]{7}[A-Z]/.test(txt)) return "NIE";
  // PASAPORTE: línea que empiece con P<
  if(/\bP</.test(txt)) return "PASAPORTE";
  return "";
}

/* ================== Validación visual ================== */
function validateAll(){
  ["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"]
    .forEach(id=>{
      const el=document.getElementById(id);
      const ok=!!(el.value&&el.value.trim());
      el.classList.toggle("valid",ok);
      el.classList.toggle("invalid",!ok);
    });
}
function updateFilename(){
  const ap=(document.getElementById('Apellidos').value||"APELLIDOS").trim();
  document.getElementById('fname').textContent = ap + ".json";
}

/* ================== Núcleo: leer portapapeles → analizar → rellenar ================== */
async function readFromClipboard(){
  try{
    const txt = await navigator.clipboard.readText();
    return txt || "";
  }catch{
    const m = prompt("Pega manualmente el OCR:");
    return m || "";
  }
}
function processOCR(ocr){
  if(!ocr.trim()){ alert("Portapapeles vacío. Copia el OCR primero."); return; }

  // MRZ
  const L3 = mrzL3_strict(ocr);
  const L1 = mrzL1_strict(ocr);
  const L2 = mrzL2_strict(ocr);

  // Nombre / Apellidos (no eliminar duplicados)
  const np = namesFromL3(L3);
  if(np.apellidos) document.getElementById('Apellidos').value = np.apellidos;
  if(np.nombre)    document.getElementById('Nombre').value    = np.nombre;

  // DNI exacto (9 previos al primer <<)
  const dni = dniFromL1(L1);
  if(dni){
    document.getElementById('Numero').value = dni;
    document.getElementById('Tipo').value   = "DNI";
  }

  // Si no hay DNI, intenta NIE o PASAPORTE
  if(!document.getElementById('Tipo').value){
    const t = detectTipoFallback(ocr);
    if(t) document.getElementById('Tipo').value = t;
  }

  // Fecha / Sexo / Nacionalidad
  const ds = dsFromL2(L2);
  if(ds.fecha) document.getElementById('Nacimiento').value = ds.fecha;
  if(ds.sexo)  document.getElementById('Sexo').value = ds.sexo;
  if(ds.nac)   document.getElementById('Nacionalidad').value = ds.nac;

  // Lugar de nacimiento (encabezados tolerantes)
  if(!document.getElementById('Lugar').value){
    const ln = lugarFromOCR(ocr);
    if(ln) document.getElementById('Lugar').value = ln;
  }

  // Domicilio (admite 1 sola línea)
  if(!document.getElementById('Domicilio').value){
    const dm = domicilioFromOCR(ocr);
    if(dm) document.getElementById('Domicilio').value = dm;
  }

  // Padres “Nombre1 y Nombre2”
  if(!document.getElementById('Padres').value || / y$/.test((document.getElementById('Padres').value||"").trim())){
    const pf = padresFromOCR(ocr);
    if(pf) document.getElementById('Padres').value = pf;
  }

  updateFilename();
  validateAll();
}

/* ================== Botones ================== */
document.getElementById('readAnalyze').addEventListener('click', async ()=>{
  const ocr = await readFromClipboard();
  processOCR(ocr);
});
document.getElementById('clear').addEventListener('click', ()=>{
  ["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"]
    .forEach(id=>document.getElementById(id).value="");
  updateFilename(); validateAll();
});
document.getElementById('Apellidos').addEventListener('input', updateFilename);

/* ================== Descargar JSON ================== */
document.getElementById('download').addEventListener('click', ()=>{
  if(!document.getElementById('Condicion').value){
    alert("Condición obligatoria");
    document.getElementById('Condicion').classList.add('invalid');
    return;
  }
  const data={
    "Nombre": document.getElementById('Nombre').value,
    "Apellidos": (document.getElementById('Apellidos').value||"").toUpperCase(),
    "Tipo de documento": document.getElementById('Tipo').value,
    "Nº Documento": document.getElementById('Numero').value,
    "Sexo": document.getElementById('Sexo').value,
    "Nacionalidad": document.getElementById('Nacionalidad').value,
    "Nombre de los Padres": document.getElementById('Padres').value,
    "Fecha de nacimiento": document.getElementById('Nacimiento').value,
    "Lugar de nacimiento": document.getElementById('Lugar').value,
    "Domicilio": document.getElementById('Domicilio').value,
    "Teléfono": document.getElementById('Telefono').value,
    "Condición": document.getElementById('Condicion').value
  };
  const fname=(document.getElementById('Apellidos').value||"APELLIDOS") + ".json";
  const a=document.createElement('a');
  a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data,null,2));
  a.download=fname; a.click();
});

/* ================== Estado inicial ================== */
updateFilename();
validateAll();
</script>

</body>
</html>
