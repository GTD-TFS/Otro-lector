<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCR DNI ‚Äì C√°mara con autoenfoque OCR</title>
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body {
      margin: 0;
      padding: 1rem;
      background: #f6f7f9;
      color: #111;
    }
    .app {
      max-width: 860px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 6px 30px rgba(0, 0, 0, 0.06);
    }
    h1 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    label {
      font-weight: 600;
    }
    input[type="file"],
    select,
    button,
    textarea {
      padding: 0.6rem 0.7rem;
      border: 1px solid #dfe3e6;
      border-radius: 10px;
      background: #fff;
      font-size: 1rem;
    }
    button.primary {
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .preview {
      width: 100%;
      max-height: 320px;
      object-fit: contain;
      border-radius: 10px;
      background: #f0f2f5;
    }
    textarea {
      width: 100%;
      min-height: 200px;
      resize: vertical;
    }
    pre {
      background: #f7f7f7;
      border-radius: 8px;
      padding: 0.7rem;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .muted {
      color: #6b7280;
      font-size: 0.9rem;
    }
    /* C√°mara */
    #camContainer {
      position: relative;
      width: 100%;
      max-width: 480px;
      aspect-ratio: 4 / 3;
      margin: 1rem auto;
      border: 6px solid #ccc;
      border-radius: 12px;
      overflow: hidden;
      transition: border-color 0.2s ease-in-out;
    }
    #camContainer.ready { border-color: #22c55e; }
    #camContainer.mid { border-color: #eab308; }
    #camContainer.bad { border-color: #ef4444; }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #focusMsg {
      position: absolute;
      bottom: 6px;
      left: 0;
      right: 0;
      text-align: center;
      color: #fff;
      background: rgba(0, 0, 0, 0.4);
      font-size: 0.9rem;
      padding: 4px 0;
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>OCR DNI con c√°mara y autoenfoque OCR</h1>

    <div class="row">
      <button id="fotoBtn" type="button">üì∏ Hacer foto</button>
      <input id="fotoInput" type="file" accept="image/*" capture="environment" hidden />
      <button id="archivoBtn" type="button">üìÅ Elegir archivo</button>
      <input id="archivoInput" type="file" accept="image/*" hidden />
      <button id="camMode" type="button">üé• Modo c√°mara</button>
    </div>

    <!-- C√°mara en vivo -->
    <div id="camContainer" style="display:none;">
      <video id="camVideo" autoplay playsinline muted></video>
      <div id="focusMsg">Enfocando...</div>
      <button id="captureBtn" type="button" style="position:absolute;right:10px;top:10px;">üì∑ Capturar</button>
    </div>

    <div class="row">
      <label for="lang">Idioma</label>
      <select id="lang">
        <option value="spa" selected>Espa√±ol</option>
        <option value="eng">Ingl√©s</option>
      </select>
      <button id="run" class="primary" type="button" style="background:#22c55e;">Leer texto</button>
      <button id="clear" type="button">Limpiar</button>
      <span id="status" class="muted">Listo.</span>
    </div>

    <img id="preview" class="preview" alt="Vista previa" />

    <div class="row" style="flex-direction:column; align-items:stretch;">
      <label for="output">Texto detectado y campos</label>
      <textarea id="output" placeholder="Aqu√≠ aparecer√° el texto reconocido‚Ä¶"></textarea>
    </div>

    <div class="row" style="flex-direction:column; align-items:stretch;">
      <div class="row" style="justify-content:space-between; padding:0;">
        <label>üîç Estructura OCR (ordenado de arriba a abajo)</label>
        <button id="toggleStruct" type="button">Mostrar/Ocultar</button>
      </div>
      <pre id="structure" style="display:none;"></pre>
    </div>
  </div>

  <!-- Tesseract -->
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const fotoBtn = $("fotoBtn"),
      fotoInput = $("fotoInput"),
      archivoBtn = $("archivoBtn"),
      archivoInput = $("archivoInput"),
      camModeBtn = $("camMode"),
      camContainer = $("camContainer"),
      camVideo = $("camVideo"),
      focusMsg = $("focusMsg"),
      captureBtn = $("captureBtn"),
      preview = $("preview"),
      runBtn = $("run"),
      clearBtn = $("clear"),
      output = $("output"),
      structure = $("structure"),
      toggleStructBtn = $("toggleStruct"),
      statusEl = $("status");

    let currentBlob = null;
    let stream = null;
    let focusInterval = null;

    function status(t) {
      statusEl.textContent = t;
    }

    // === C√ÅMARA ===
    camModeBtn.addEventListener("click", async () => {
      if (camContainer.style.display === "none") {
        camContainer.style.display = "block";
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });
          camVideo.srcObject = stream;
          startFocusMonitor();
        } catch (e) {
          alert("No se pudo acceder a la c√°mara.");
        }
      } else {
        stopCamera();
      }
    });

    function stopCamera() {
      camContainer.style.display = "none";
      if (stream) {
        stream.getTracks().forEach((t) => t.stop());
        stream = null;
      }
      if (focusInterval) {
        clearInterval(focusInterval);
        focusInterval = null;
      }
    }

    function calcFocusScore(frame) {
      const canvas = document.createElement("canvas");
      canvas.width = frame.videoWidth;
      canvas.height = frame.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(frame, 0, 0);
      const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const d = img.data;
      const gray = new Uint8Array(canvas.width * canvas.height);
      for (let i = 0, j = 0; i < d.length; i += 4, j++) {
        gray[j] = 0.299 * d[i] + 0.587 * d[i + 1] + 0.114 * d[i + 2];
      }
      // Calcular gradiente medio (simple y r√°pido)
      let sum = 0,
        count = 0;
      const w = canvas.width,
        h = canvas.height;
      for (let y = 1; y < h; y += 2) {
        for (let x = 1; x < w; x += 2) {
          const idx = y * w + x;
          const g =
            Math.abs(gray[idx] - gray[idx - 1]) +
            Math.abs(gray[idx] - gray[idx - w]);
          sum += g;
          count++;
        }
      }
      return sum / count;
    }

    function startFocusMonitor() {
      focusInterval = setInterval(() => {
        if (!camVideo.videoWidth) return;
        const score = calcFocusScore(camVideo);
        const cont = camContainer;
        if (score > 12) {
          cont.className = "ready";
          focusMsg.textContent = "‚úÖ Enfocado, toca para capturar";
        } else if (score > 7) {
          cont.className = "mid";
          focusMsg.textContent = "üü° Mejorando enfoque...";
        } else {
          cont.className = "bad";
          focusMsg.textContent = "üî¥ Borroso / poca luz";
        }
      }, 400);
    }

    captureBtn.addEventListener("click", () => {
      if (!camVideo.videoWidth) return;
      const c = document.createElement("canvas");
      c.width = camVideo.videoWidth;
      c.height = camVideo.videoHeight;
      const ctx = c.getContext("2d");
      ctx.drawImage(camVideo, 0, 0);
      c.toBlob((b) => {
        currentBlob = b;
        preview.src = URL.createObjectURL(b);
        stopCamera();
        status("Imagen capturada desde c√°mara.");
      }, "image/jpeg", 0.9);
    });

    // === ARCHIVO / FOTO ===
    fotoBtn.addEventListener("click", () => fotoInput.click());
    archivoBtn.addEventListener("click", () => archivoInput.click());
    fotoInput.addEventListener("change", () =>
      onPick(fotoInput.files?.[0])
    );
    archivoInput.addEventListener("change", () =>
      onPick(archivoInput.files?.[0])
    );

    function onPick(file) {
      if (!file) return;
      currentBlob = file;
      preview.src = URL.createObjectURL(file);
      output.value = "";
      structure.textContent = "";
      structure.style.display = "none";
      status("Imagen cargada.");
    }

    clearBtn.addEventListener("click", () => {
      currentBlob = null;
      fotoInput.value = "";
      archivoInput.value = "";
      preview.removeAttribute("src");
      output.value = "";
      structure.textContent = "";
      structure.style.display = "none";
      status("Listo.");
    });

    toggleStructBtn.addEventListener("click", () => {
      structure.style.display =
        structure.style.display === "none" ? "" : "none";
    });
  </script>
</body>
</html>
