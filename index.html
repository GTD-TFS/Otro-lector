<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DILIPOL · Filiación · OCR → JSON</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#e6eefc; --muted:#9bb1d4; --accent:#4da3ff;
      --card:rgba(255,255,255,0.08); --border:rgba(255,255,255,0.18);
      --shadow:0 10px 30px rgba(0,0,0,0.35); --radius:14px;
      --green:#30d690; --red:#ff4f4f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:20px;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--fg); background:
      radial-gradient(1200px 600px at 10% -10%, #1a2a4a 0%, transparent 60%),
      radial-gradient(1000px 700px at 110% 10%, #163560 0%, transparent 55%),
      linear-gradient(180deg, #0b1220 0%, #0b1220 100%);
    }
    h1{margin:0 0 14px; font-size:20px; letter-spacing:.3px}
    .grid{display:grid; gap:16px}
    .two{grid-template-columns:1fr}
    @media(min-width:900px){ .two{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px; backdrop-filter: blur(10px);
    }
    .card h2{margin:0 0 10px; font-size:15px; color:#dbe7ff}

    textarea{
      width:100%; min-height:32vh; background:rgba(10,16,28,0.45); color:var(--fg);
      border:1px solid var(--border); border-radius:12px; padding:12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px}
    .btn{
      border:1px solid var(--accent);
      background:linear-gradient(180deg, rgba(77,163,255,0.25), rgba(77,163,255,0.12));
      color:#e9f3ff; padding:10px 14px; border-radius:12px; cursor:pointer;
    }
    .btn.secondary{
      border-color:var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      color:#e6eefc;
    }
    .fields{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:760px){ .fields{grid-template-columns:1fr 1fr} }
    label{display:block; font-size:12px; color:#cfe0ff; margin:0 0 6px}
    input,select{
      width:100%; padding:10px 12px; border-radius:12px;
      border:2px solid var(--border); background:rgba(10,16,28,0.45); color:var(--fg);
      outline:none; transition:border-color .15s;
    }
    input.valid,select.valid{border-color:var(--green)}
    input.invalid,select.invalid{border-color:var(--red)}
    .span2{grid-column:1 / -1}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace; font-size:12px}
    .bar{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .filehint{font-size:12px; color:#bcd0f0}
  </style>
</head>
<body>
  <h1>DILIPOL · Filiación · OCR → JSON</h1>

  <div class="grid two">
    <!-- 1) PEGADO OCR -->
    <div class="card">
      <h2>1) Pegar OCR</h2>
      <textarea id="ocr" placeholder="Pega aquí el texto OCR obtenido con Lens / Atajo…"></textarea>
      <div class="row">
        <button class="btn" id="pasteClipboard">Pegar del portapapeles</button>
        <button class="btn secondary" id="clear">Limpiar</button>
        <button class="btn" id="analyze">Analizar OCR</button>
      </div>
    </div>

    <!-- 2) CAMPOS -->
    <div class="card">
      <h2>2) Revisar / completar</h2>
      <div class="fields">
        <div><label>Nombre</label><input id="Nombre"></div>
        <div><label>Apellidos (MAYÚSCULAS)</label><input id="Apellidos"></div>
        <div><label>Tipo de documento</label><input id="Tipo" placeholder="DNI / NIE / PASAPORTE"></div>
        <div><label>Nº Documento</label><input id="Numero"></div>
        <div>
          <label>Sexo</label>
          <select id="Sexo">
            <option value=""></option>
            <option>MASCULINO</option>
            <option>FEMENINO</option>
          </select>
        </div>
        <div><label>Nacionalidad</label><input id="Nacionalidad" placeholder="España / ESP / ..."></div>
        <div class="span2"><label>Nombre de los Padres (Nombre1 y Nombre2)</label><input id="Padres" placeholder="Juan y Victoria"></div>
        <div><label>Fecha de nacimiento</label><input id="Nacimiento" placeholder="dd/mm/aaaa"></div>
        <div><label>Lugar de nacimiento</label><input id="Lugar"></div>
        <div class="span2"><label>Domicilio</label><input id="Domicilio"></div>
        <div><label>Teléfono</label><input id="Telefono" inputmode="numeric" pattern="[0-9 ]*"></div>
        <div>
          <label>Condición <span class="muted">(obligatorio)</span></label>
          <select id="Condicion" required>
            <option value=""></option>
            <option>Requirente</option>
            <option>Perjudicado</option>
            <option>Testigo</option>
            <option>Identificado</option>
            <option>Detenido</option>
          </select>
        </div>
      </div>

      <div class="bar" style="margin-top:12px">
        <div class="row" style="margin:0">
          <button class="btn" id="download">Descargar JSON</button>
          <span class="filehint">→ <span class="mono" id="fname">APELLIDOS.json</span></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* === Limpieza fuerte y utilidades === */
    const cleanUnicode = s => s.normalize("NFD").replace(/[^\x00-\x7FÀ-ÿ0-9 .,/()\-<]+/g,'');
    const collapse      = s => s.replace(/\s+/g,' ').trim();
    const titleCase     = s => s.toLowerCase().replace(/\b([A-Za-zÁÉÍÓÚÜÑáéíóúüñ]+)/g, w => w.charAt(0).toUpperCase() + w.slice(1));
    const onlyMRZ       = s => s.toUpperCase().replace(/[^A-Z0-9<]/g,'');

    /* === Detectores EXCESIVOS de encabezados (tolerantes a OCR roto) === */
    const isDomicilio = l => /(DOMI|COMI|D0MI|DOMIL|DOMICIO|DOMlC|D0MIC|DIREC|CALLE|CL |AVDA|AVENID|VIA|URB|URBAN|RESID|PISO|PLANTA|NUM|N[ÚU]M|CR |CAMIN|CTRA|BLOQ|PORTAL)/.test(l);
    const isNacimiento = l => (/(L[UI]G[AO]R|LAGAR|LIGAR|LUGAR|LUGOR|LOCALID|CIUDAD|POBLAC|PROVIN|BIRTH)/.test(l) && /(NAC[II1]M[EI]ENT|NACIM|NACIMENTO|NADMI|NADIM)/.test(l)) || /(LUGAR DE NAC|NACIMIENTO)/.test(l);
    const isPadres = l => /(HIJ[O0]\/?A DE|H[I1]J[O0]\/?A DE|HIO\/?A DE|HIIO\/?A DE|HJIO\/?A DE|NUOIA DE|N[IU]OIA DE|HUDIA DE|MADIA DE|MADRE|PADRE|PROGEN|TUTOR|REPRES|PADRES)/.test(l);
    const isEquipo = l => /EQUIPO/.test(l);

    /* Cortes duros de bloque: MRZ o códigos sueltos */
    const isMRZLike   = l => /<{2,}/.test(l) || (l.includes('<') && /^[A-Z0-9<]{6,}$/.test(l));
    const isCodeToken = l => /^[A-Z0-9]{5,12}$/.test(l);

    /* Heurística de línea de dirección sin encabezado explícito */
    const looksLikeAddress = l =>
      /(C\.|CALLE|CL |AVDA|AVENIDA|PZA|PLAZA|CR |CARRETERA|CM |CAMINO|CTRA|BARRIO|URB|URBANIZACION|VIA|PISO|PORTAL|BLOQ|ESC|PLANTA)/.test(l)
      || /\b[0-9]{1,4}[A-Z]?\b/.test(l);

    /* DNI checksum */
    const dniLetter = n => "TRWAGMYFPDXBNJZSQVHLCKE"[parseInt(n,10)%23];

    /* MRZ: extraer aproximadas L1/L2/L3 desde líneas con << */
    function extractMRZLines(ocrText){
      const lines = ocrText.replace(/\r/g,'').split('\n').map(s=>cleanUnicode(s.trim())).filter(Boolean);
      const mrzLines = lines.filter(l=>l.includes('<<')).map(onlyMRZ);
      const L1 = mrzLines[0] || "";                      // primera con cerco
      const L3 = mrzLines[mrzLines.length-1] || "";      // última suele ser nombres
      // L2: buscar línea con YYMMDD + sexo + país (aprox)
      const L2cand = lines.find(l=>/[0-9]{2}[0-9]{2}[0-9]{2}.*[MF].*[A-Z]{3}/.test(l.toUpperCase())) || "";
      const L2 = onlyMRZ(L2cand);
      return {L1, L2, L3};
    }

    /* DNI por cerco estricto (primer '<' en L1) */
    function dniFromL1(L1){
      if(!L1) return "";
      const j = L1.indexOf("<<")>=0 ? L1.indexOf("<<") : L1.indexOf("<");
      if(j < 9) return "";
      const cand = L1.slice(j-9, j);           // 8 dígitos + 1 letra
      if(!/^[0-9]{8}[A-Z]$/.test(cand)) return "";
      return dniLetter(cand.slice(0,8)) === cand.slice(-1) ? cand : "";
    }

    /* Tipo de documento: fuerza DNI si número válido */
    function tipoDocumento(L1, numeroValido){
      if(numeroValido) return "DNI";
      if(/^ID.*ESP/.test(L1)) return "DNI";
      if(/^I.*ESP/.test(L1) && /[XYZ][0-9]{7}[A-Z]/.test(L1)) return "NIE";
      if(/^P</.test(L1)) return "PASAPORTE";
      return "";
    }

    /* Nombres y apellidos desde L3 APELLIDOS<<NOMBRES */
    function nombreApellidos(L3){
      if(!L3 || !L3.includes("<<")) return {nombre:"", apellidos:""};
      const i = L3.indexOf("<<");
      let ap_raw  = L3.slice(0,i).replace(/^<+|<+$/g,'').replace(/<+/g,' ').trim();
      let nom_raw = L3.slice(i+2).replace(/^<+|<+$/g,'').replace(/<+/g,' ').trim();
      // limpia nacionalidades falsas en apellidos (ESPANOLA)
      ap_raw = ap_raw.replace(/\bESPANOLA?\b/gi,'').trim();
      return {nombre: titleCase(nom_raw), apellidos: ap_raw.toUpperCase()};
    }

    /* Fecha, sexo, nacionalidad desde L2 (YYMMDD -> dd/mm/aaaa) */
    function datosDesdeL2(L2){
      let fecha="", sexo="", nac="";
      if(L2){
        const m = L2.match(/([0-9]{2})([0-9]{2})([0-9]{2})/);
        if(m){
          const yy = +m[1], mm=m[2], dd=m[3];
          const year = yy >= 30 ? 1900+yy : 2000+yy;
          fecha = `${dd}/${mm}/${year}`;
        }
        const sx = L2.match(/[MF]/);
        if(sx) sexo = sx[0]==="F" ? "FEMENINO" : "MASCULINO";
        const nat = (L2.match(/[A-Z]{3}(?=<{2,}|$)/g)||[]).pop() || "";
        nac = nat==="ESP" ? "España" : (nat || "");
      }
      return {fecha, sexo, nac};
    }

    /* Extraer bloques con cortes duros + domicilio implícito + HIJO/A DE en misma línea */
    function extractBlocks(ocrText){
      const raw0 = ocrText.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
      const raw  = raw0.map(cleanUnicode).filter(Boolean);
      const up   = raw.map(s=>s.toUpperCase());

      const nextStop = (idx)=>{
        for(let k=idx+1;k<up.length;k++){
          const L = up[k];
          if (isDomicilio(L) || isNacimiento(L) || isPadres(L) || isEquipo(L) || isMRZLike(L) || isCodeToken(L)) return k;
        }
        return up.length;
      };

      // DOMICILIO con encabezado
      let domicilio="";
      const dIdx = up.findIndex(isDomicilio);
      if(dIdx>=0){
        const end = nextStop(dIdx);
        const lines = raw.slice(dIdx+1,end)
          .filter(s=>!/^DNI$/.test(s.toUpperCase()))
          .filter(s=>!isMRZLike(s.toUpperCase()))
          .filter(s=>!isCodeToken(s.toUpperCase()))
          .filter(Boolean);
        domicilio = titleCase(collapse(lines.join(', ')));
        // de-dupe coma (S-N, S-N)
        if(domicilio){
          const parts = domicilio.split(',').map(x=>x.trim());
          const seen = new Set(); const out=[];
          for(const p of parts){ const k=p.toUpperCase(); if(!seen.has(k)){ seen.add(k); out.push(p); } }
          domicilio = out.join(', ');
        }
      }

      // DOMICILIO implícito si no hay encabezado
      if(!domicilio){
        let end0 = up.length;
        for(let k=0;k<up.length;k++){
          const L = up[k];
          if (isDomicilio(L)||isNacimiento(L)||isPadres(L)||isEquipo(L)||isMRZLike(L)) { end0 = k; break; }
        }
        const addrLines = [];
        for(let i=0;i<end0;i++){
          const L = up[i];
          if (isCodeToken(L)) continue;
          if (looksLikeAddress(L)) addrLines.push(raw[i]);
        }
        if(addrLines.length){
          let tmp = titleCase(collapse(addrLines.join(', ')));
          const parts = tmp.split(',').map(x=>x.trim());
          const seen = new Set(); const out=[];
          for(const p of parts){ const k=p.toUpperCase(); if(!seen.has(k)){ seen.add(k); out.push(p); } }
          domicilio = out.join(', ');
        }
      }

      // NACIMIENTO
      let nacimiento="";
      const nIdx = up.findIndex(isNacimiento);
      if(nIdx>=0){
        const end = nextStop(nIdx);
        const lines = raw.slice(nIdx+1,end)
          .filter(s=>!isMRZLike(s.toUpperCase()))
          .filter(s=>!isCodeToken(s.toUpperCase()));
        nacimiento = titleCase(collapse(lines.join(', ')));
      }

      // PADRES (acepta inline tras encabezado + siguientes líneas)
      let padres="";
      const pIdx = up.findIndex(isPadres);
      if(pIdx>=0){
        const headerRaw = raw[pIdx];
        // Inline tras encabezado (si viene)
        let inline = headerRaw.replace(/.*?(HIJ[O0]\/?A DE|H[I1]J[O0]\/?A DE|HIO\/?A DE|HIIO\/?A DE|HJIO\/?A DE|NUOIA DE|N[IU]OIA DE|HUDIA DE|MADIA DE|MADRE|PADRE|PROGEN|TUTOR|REPRES|PADRES)\s*/i,'').trim();
        inline = inline.replace(/[<>,;]+/g,' ').trim();
        let names = [];
        if(inline) names.push(inline);
        // siguientes 2 líneas no MRZ/no código
        for(let t=1; t<=2; t++){
          const cand = raw[pIdx+t];
          if(!cand) break;
          const U = cand.toUpperCase();
          if(isMRZLike(U) || isCodeToken(U) || isDomicilio(U) || isNacimiento(U) || isEquipo(U)) break;
          names.push(cand);
        }
        // partir por / , ; o “ y ”
        let flat = names.join(' / ');
        let parts = flat.split(/[\/,;]+/).map(s=>collapse(s)).filter(Boolean);
        const p1 = parts[0] ? titleCase(parts[0]) : "";
        const p2 = parts[1] ? titleCase(parts[1]) : "";
        padres = (p1||p2) ? `${p1} y ${p2}`.trim() : "";
      }

      return {domicilio, nacimiento, padres};
    }

    /* === Validación visual (verde/rojo) === */
    function applyValidation(){
      ["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"]
        .forEach(id=>{
          const el = document.getElementById(id);
          if(!el) return;
          const ok = !!(el.value && el.value.trim());
          el.classList.toggle('valid', ok);
          el.classList.toggle('invalid', !ok);
        });
    }

    /* === Pegar del portapapeles con fallback === */
    document.getElementById('pasteClipboard').addEventListener('click', async ()=>{
      try{
        const txt = await navigator.clipboard.readText();
        if(txt && txt.trim()){ ocr.value = txt; document.getElementById('analyze').click(); return; }
        throw new Error("Empty");
      }catch(e){
        const txt = prompt("Pega aquí el texto OCR:", "");
        if(txt && txt.trim()){ ocr.value = txt; document.getElementById('analyze').click(); }
      }
    });

    /* Auto-analizar al pegar manual */
    document.getElementById('ocr').addEventListener('paste', ()=>{
      setTimeout(()=>document.getElementById('analyze').click(), 40);
    });

    /* Limpiar */
    document.getElementById('clear').addEventListener('click', ()=>{
      document.getElementById('ocr').value="";
      ["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"]
        .forEach(id=>document.getElementById(id).value="");
      applyValidation();
      updateFilename();
    });

    /* Analizar OCR → campos (SIN estatus en pantalla) */
    document.getElementById('analyze').addEventListener('click', ()=>{
      const raw = document.getElementById('ocr').value || "";
      const ocr = cleanUnicode(raw);
      if(!ocr.trim()) return;

      const {L1, L2, L3} = extractMRZLines(ocr);
      const {nombre, apellidos} = nombreApellidos(L3);
      const {fecha, sexo, nac} = datosDesdeL2(L2);
      const numero = dniFromL1(L1);
      const tipo = tipoDocumento(L1, !!numero);

      const {domicilio, nacimiento, padres} = extractBlocks(ocr);

      // Relleno
      Nombre.value       = titleCase(nombre || "");
      Apellidos.value    = (apellidos || "").toUpperCase();
      Tipo.value         = tipo;
      Numero.value       = numero;
      Sexo.value         = sexo;
      Nacionalidad.value = nac === "ESP" ? "España" : (nac || "");
      Padres.value       = padres;
      Nacimiento.value   = fecha;
      Lugar.value        = nacimiento;
      Domicilio.value    = domicilio;

      updateFilename();
      applyValidation();
    });

    /* Nombre de archivo dinámico */
    function updateFilename(){
      const ap = (Apellidos.value || "").trim().replace(/[\/\\]+/g,'-').replace(/\s+/g,' ');
      document.getElementById('fname').textContent = (ap ? ap : "APELLIDOS") + ".json";
    }
    document.getElementById('Apellidos').addEventListener('input', updateFilename);

    /* Validación en tiempo real */
    document.querySelectorAll("input,select").forEach(el=>{
      el.addEventListener("input", applyValidation);
      el.addEventListener("blur", applyValidation);
    });

    /* Descargar JSON (Condición obligatoria) */
    document.getElementById('download').addEventListener('click', ()=>{
      if(!Condicion.value){
        alert("Selecciona la Condición antes de descargar (Requirente, Perjudicado, Testigo, Identificado o Detenido).");
        Condicion.focus();
        return;
      }
      const data = {
        "Nombre": Nombre.value || "",
        "Apellidos": (Apellidos.value || "").toUpperCase(),
        "Tipo de documento": Tipo.value || "",
        "Nº Documento": Numero.value || "",
        "Sexo": Sexo.value || "",
        "Nacionalidad": (Nacionalidad.value === "ESP" ? "España" : (Nacionalidad.value || "")),
        "Nombre de los Padres": Padres.value || "",
        "Fecha de nacimiento": Nacimiento.value || "",
        "Lugar de nacimiento": Lugar.value || "",
        "Domicilio": Domicilio.value || "",
        "Teléfono": Telefono.value || "",
        "Condición": Condicion.value
      };
      const ap = (Apellidos.value.trim() || "APELLIDOS") + ".json";
      const a = document.createElement('a');
      a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data,null,2));
      a.download = ap;
      document.body.appendChild(a); a.click(); a.remove();
    });

    // Estado inicial: marcos rojos en vacío
    applyValidation();
  </script>
</body>
</html>
