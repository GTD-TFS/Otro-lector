<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCR DNI con autoenfoque inteligente</title>
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    body {
      margin: 0;
      padding: 1rem;
      font-family: system-ui, sans-serif;
      background: #f6f7f9;
      color: #111;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 6px 30px rgba(0,0,0,.06);
    }
    h1 { margin-top: 0; }
    #camContainer {
      position: relative;
      width: 100%;
      aspect-ratio: 4/3;
      max-width: 480px;
      margin: 1rem auto;
      border: 6px solid #ccc;
      border-radius: 12px;
      overflow: hidden;
      transition: border-color 0.2s ease;
    }
    #camContainer.good { border-color: #22c55e; }
    #camContainer.mid { border-color: #eab308; }
    #camContainer.bad { border-color: #ef4444; }
    video { width: 100%; height: 100%; object-fit: cover; }
    #focusMsg {
      position: absolute; bottom: 6px; left: 0; right: 0;
      text-align: center; color: #fff;
      background: rgba(0,0,0,0.4);
      padding: 4px 0; font-size: .9rem;
    }
    button {
      padding: 0.6rem 0.9rem;
      border: none; border-radius: 8px;
      font-size: 1rem; cursor: pointer;
      background: #111; color: #fff;
    }
    button:disabled { opacity: .5; cursor: not-allowed; }
    #preview { width: 100%; max-height: 300px; object-fit: contain; margin-top: .5rem; }
    textarea { width: 100%; min-height: 150px; margin-top: .5rem; }
    pre {
      background: #f7f7f7;
      border-radius: 8px;
      padding: .7rem;
      overflow-x: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>OCR DNI con autoenfoque inteligente</h1>

    <div id="camContainer" class="bad">
      <video id="camVideo" autoplay playsinline muted></video>
      <div id="focusMsg">Inicializando cÃ¡maraâ€¦</div>
    </div>

    <div style="display:flex;gap:.5rem;">
      <button id="toggleCam">ðŸŽ¥ Iniciar cÃ¡mara</button>
      <button id="runOCR" disabled>ðŸ“– Leer texto</button>
      <button id="clear">ðŸ§¹ Limpiar</button>
    </div>

    <img id="preview" alt="Captura" />
    <textarea id="output" placeholder="Texto reconocidoâ€¦"></textarea>

    <h3>Campos normalizados</h3>
    <pre id="fields"></pre>
  </div>

  <!-- OCR -->
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script type="module">
    import { SmartCamera } from './camera.js';
    const cam = new SmartCamera({
      videoEl: document.getElementById('camVideo'),
      containerEl: document.getElementById('camContainer'),
      messageEl: document.getElementById('focusMsg')
    });

    const toggleBtn = document.getElementById('toggleCam');
    const ocrBtn = document.getElementById('runOCR');
    const clearBtn = document.getElementById('clear');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');
    const fieldsEl = document.getElementById('fields');
    let currentBlob = null;

    toggleBtn.onclick = async () => {
      if (!cam.active) {
        await cam.start();
        toggleBtn.textContent = 'ðŸ›‘ Detener cÃ¡mara';
      } else {
        cam.stop();
        toggleBtn.textContent = 'ðŸŽ¥ Iniciar cÃ¡mara';
      }
    };

    cam.onReadyToCapture = (blob) => {
      currentBlob = blob;
      preview.src = URL.createObjectURL(blob);
      ocrBtn.disabled = false;
      output.value = 'Imagen capturada automÃ¡ticamente âœ…';
    };

    clearBtn.onclick = () => {
      currentBlob = null;
      output.value = '';
      preview.src = '';
      fieldsEl.textContent = '';
      ocrBtn.disabled = true;
    };

    // === OCR + parser ===
    ocrBtn.onclick = async () => {
      if (!currentBlob) return;
      output.value = 'Procesando OCRâ€¦';
      fieldsEl.textContent = '';
      const worker = await Tesseract.createWorker('spa', 1, {
        logger: m => console.log(m)
      });
      const { data } = await worker.recognize(currentBlob);
      await worker.terminate();
      const text = data.text.trim();
      output.value = text;
      const parsed = parseDNI(text);
      fieldsEl.textContent = JSON.stringify(parsed, null, 2);
    };

    // === Parser bÃ¡sico DNI ===
    function parseDNI(text) {
      const norm = s => (s||'').normalize('NFD')
        .replace(/\p{Diacritic}/gu,'')
        .replace(/[^\p{L}\p{N}\s]/gu,' ')
        .replace(/\s+/g,' ')
        .trim()
        .toUpperCase();

      const out = {
        "Nombre": "",
        "Apellidos": "",
        "Tipo documento": "DNI",
        "NÂº Documento": "",
        "Sexo": "",
        "Nacionalidad": "",
        "Fecha nacimiento": "",
      };

      const clean = norm(text);

      // NÂº Documento
      const mDni = clean.match(/\b\d{8}[A-Z]\b/);
      if (mDni) out["NÂº Documento"] = mDni[0];

      // Nombre / Apellidos
      const lines = clean.split(/\n| {2,}/);
      for (let i = 0; i < lines.length; i++) {
        const l = lines[i];
        if (l.includes("APELLID")) {
          out["Apellidos"] = (lines[i+1]||"").split(' ').slice(0,3).join(' ');
        }
        if (l.includes("NOMBRE")) {
          out["Nombre"] = (lines[i+1]||"").split(' ').slice(0,2).join(' ');
        }
      }

      // Sexo / Nacionalidad / Fecha
      const mLine = clean.match(/\b[MF]\b.*?\b[A-Z]{3}\b.*?\b\d{1,2} \d{1,2} \d{4}\b/);
      if (mLine) {
        const parts = mLine[0].split(/\s+/);
        out["Sexo"] = parts[0];
        out["Nacionalidad"] = parts.find(p => p.length===3 && /[A-Z]{3}/.test(p)) || "";
        const fecha = mLine[0].match(/\d{1,2} \d{1,2} \d{4}/);
        if (fecha) out["Fecha nacimiento"] = fecha[0].replace(/\s/g,'/');
      }

      return out;
    }
  </script>
</body>
</html>
