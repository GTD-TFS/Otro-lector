<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FILIATRON</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#e6eefc; --accent:#4da3ff;
      --card:rgba(255,255,255,.08); --border:rgba(255,255,255,.18);
      --green:#22c57b; --red:#ff5656;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;font-family:system-ui,"Segoe UI",Arial;color:var(--fg);background:#0b1220}
    h1{margin:0 0 14px;font-size:20px}
    .grid{display:grid;gap:16px}
    .two{grid-template-columns:1fr}
    @media(min-width:900px){.two{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;backdrop-filter:blur(10px)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid var(--accent);color:var(--fg);background:rgba(77,163,255,.15);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.secondary{border-color:var(--border);background:rgba(255,255,255,.05)}
    .fields{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:760px){.fields{grid-template-columns:1fr 1fr}}
    label{font-size:12px;margin-bottom:4px;color:#cfe0ff}
    input,select{
      width:100%;padding:10px;border-radius:12px;background:rgba(10,16,28,.45);
      color:var(--fg);border:1px solid var(--border);outline:none;transition:border-color .15s
    }
    /* bordes finos */
    input.valid,select.valid{border-color:var(--green)!important}
    input.invalid,select.invalid{border-color:var(--red)!important}
    .span2{grid-column:1/-1}
    .mono{font-size:12px}
    .hint{font-size:12px;color:#bcd0f0}
  </style>
</head>
<body>
<h1>DILIPOL · Filiación · OCR → JSON</h1>

<div class="grid two">
 <!-- ACCIONES -->
<div class="card">
  <div class="row">
    <button class="btn" onclick="window.open('https://chatgpt.com/g/g-68fe060630348191b62c44416164a37d-ocr-dni','_blank','noopener')">
      📷 Foto IA
    </button>
    <button class="btn" id="readAnalyze">Integrar</button>
    <button class="btn secondary" id="clear" title="Limpiar">🧹</button>
  </div>
 
</div>
  <!-- CAMPOS -->
  <div class="card">
    <div class="fields">
      <div><label>Nombre</label><input id="Nombre"></div>
      <div><label>Apellidos (MAYÚSCULAS)</label><input id="Apellidos"></div>
      <div><label>Tipo de documento</label><input id="Tipo" placeholder="DNI / NIE / PASAPORTE"></div>
      <div><label>Nº documento</label><input id="Numero"></div>
      <div><label>Sexo</label>
        <select id="Sexo"><option></option><option>MASCULINO</option><option>FEMENINO</option></select>
      </div>
      <div><label>Nacionalidad</label><input id="Nacionalidad" placeholder="España / ESP / ..."></div>
      <div class="span2"><label>Nombre de los Padres (Nombre1 y Nombre2)</label><input id="Padres" placeholder="Juan y Victoria"></div>
      <div><label>Fecha de nacimiento</label><input id="Nacimiento" placeholder="dd/mm/aaaa"></div>
      <div><label>Lugar de nacimiento</label><input id="Lugar"></div>
      <div class="span2"><label>Domicilio</label><input id="Domicilio"></div>
      <div><label>Teléfono</label><input id="Telefono" inputmode="numeric" pattern="[0-9 ]*"></div>
      <div><label>Condición (oblig.)</label>
        <select id="Condicion">
          <option></option><option>Requirente</option><option>Perjudicado</option>
          <option>Testigo</option><option>Identificado</option><option>Detenido</option>
        </select>
      </div>
    </div>
    <div class="row">
  <button class="btn" id="download">Descargar JSON</button>
  <button class="btn" id="openIA" style="display:flex;gap:6px;align-items:center;">
    📷 Foto IA
  </button>
</div>
  </div>
</div>

<script>
/* ========= Utilidades básicas ========= */
const toLines = (txt) => (txt || "")
  .split(/\r?\n/)
  .map(s => s.trim())
  .filter(s => s.length > 0);

const tcase = s => (s||"").toLowerCase().replace(/\b([A-Za-zÁÉÍÓÚÜÑáéíóúüñ])/g,c=>c.toUpperCase());
const ucase = s => (s||"").toUpperCase();

/* ========= Lectura de portapapeles ========= */
async function readFromClipboard(){
  try{
    const txt = await navigator.clipboard.readText();
    return txt || "";
  }catch{
    const m = prompt("Pega manualmente el OCR (texto bruto, línea por línea):");
    return m || "";
  }
}

function parseByRules(ocrRaw){
  const lines = toLines(ocrRaw);
  const U = lines.map(ucase);

  const isCodeToken = s => /^[A-Z0-9]{6,}$/.test((s||"").toUpperCase());
  const isMrzLike = s => (s||"").includes("<");
  const nextPlainIndex = (start)=>{
    for(let i=start;i<lines.length;i++){
      const up=U[i]||"";
      const raw=lines[i]||"";
      if(!raw.trim()) continue;
      if(isMrzLike(up)) continue;
      if(up==="EQUIPO") continue;
      if(isCodeToken(up)) continue;
      return i;
    }
    return -1;
  };

  /* ---- DOMICILIO: variantes + fallback primeras líneas (con consumo) ---- */
  let domicilio = "";
  let afterDomIdx = 0; // índice desde el que buscar el siguiente campo si no hay anclas
  {
    const isAddrHeader = (s) => /^(DOMICILIO|DIRECCION|DIRECCIÓN|DOM\.|DOMIC)$/.test(s);
    const looksAddrLine = (s) => /(AVDA|AVENIDA|CALLE|C\.|C\/|CL |PZA|PLAZA|CTRA|CARRE|CARRETERA|URB|VIA)/.test(s);
  
    let anchorIdx = U.findIndex(isAddrHeader);
    if (anchorIdx >= 0) {
      const l2 = lines[anchorIdx+1] || "";
      const l3 = lines[anchorIdx+2] || "";
      domicilio = [l2, l3].filter(Boolean).join(", ");
      domicilio = tcase(domicilio);
      afterDomIdx = anchorIdx + 3; // pasamos más allá del bloque de domicilio
    }
  
    if (!domicilio) {
      const first = U[0] || "";
      if (looksAddrLine(first)) {
        domicilio = [lines[0] || "", lines[1] || ""].filter(Boolean).join(", ");
        domicilio = tcase(domicilio);
        afterDomIdx = 2; // hemos consumido dos primeras líneas
      }
    }
  
    if (!domicilio) {
      domicilio = [lines[0] || "", lines[1] || ""].filter(Boolean).join(", ");
      domicilio = tcase(domicilio);
      afterDomIdx = 2;
    }
  }

  /* ---- LUGAR DE NACIMIENTO: ancla o búsqueda tras domicilio ---- */
  let lugarNac = "";
  let afterLugarIdx = afterDomIdx; // se actualizará al finalizar este bloque
  {
    const anchorIdx = U.findIndex(l => /^LUGAR\s+DE\s+NAC(IMIENTO)?$/.test(l));
    if (anchorIdx >= 0) {
      const a1 = lines[anchorIdx+1] || "";
      const a2 = lines[anchorIdx+2] || "";
      if (a1) {
        lugarNac = a1;
        if (a2 && ucase(a2) !== ucase(a1)) lugarNac += ", " + a2;
        lugarNac = tcase(lugarNac);
        afterLugarIdx = anchorIdx + 3;
      }
    }
    if (!lugarNac) {
      const i1 = nextPlainIndex(afterDomIdx);
      if (i1 !== -1) {
        const l1 = lines[i1] || "";
        const i2 = nextPlainIndex(i1 + 1);
        const l2 = (i2 !== -1) ? (lines[i2] || "") : "";
        lugarNac = l1;
        if (l2 && ucase(l2) !== ucase(l1)) lugarNac += ", " + l2;
        lugarNac = tcase(lugarNac);
        afterLugarIdx = (i2 !== -1) ? (i2 + 1) : (i1 + 1);
      }
    }
  }

 /* ---- PADRES: ancla o búsqueda tras lugar de nacimiento ---- */
  let padres = "";
  {
    const anchorIdx = U.findIndex(l =>
      /^(HIJ[O0]\/?A)\s+DE$/.test(l) || /^PADRES?$/.test(l) || /PROGEN|TUTOR|REPRES/.test(l)
    );
    let raw = "";
    if (anchorIdx >= 0) {
      raw = lines[anchorIdx+1] || "";
    } else {
      const i = nextPlainIndex(afterLugarIdx);
      if (i !== -1) raw = lines[i] || "";
    }
    if (raw) {
      let p = raw.replace(/\s*\/\s*/g, " y ");
      if (!/ y /i.test(p)) {
        const parts = (raw||"").split(/\s+/).filter(Boolean);
        p = parts.length >= 2 ? parts[0] + " y " + parts.slice(1).join(" ") : (raw + " y");
      }
      padres = tcase(p.trim());
    }
  }

  /* ---- MRZ: intentar detectar las tres últimas líneas con '<' ---- */
  function lastMrzTriplet(ls){
    const withAngles = ls.filter(s => s.includes("<"));
    if(withAngles.length >= 3){
      return withAngles.slice(-3);
    }
    // fallback: tomar literalmente las últimas 3 líneas
    return ls.slice(-3);
  }
  const [MRZ_L1_raw, MRZ_L2_raw, MRZ_L3_raw] = lastMrzTriplet(lines);
  const MRZ_L1 = (MRZ_L1_raw || "").toUpperCase().replace(/\s+/g,"");
  const MRZ_L2 = (MRZ_L2_raw || "").toUpperCase().replace(/\s+/g,"");
  const MRZ_L3 = (MRZ_L3_raw || "").toUpperCase().replace(/\s+/g,"");

  /* ---- Nacionalidad desde L1 (variantes IDESP) ---- */
  function isSpainFromL1(l1){
    // Normalizamos confusiones comunes: 1→I, l→I, 5→S, 0/O→O, B no afecta, D/O ambiguo
    const norm = l1
      .replace(/[1lİＩ]/g,'I')
      .replace(/[5Ｓ]/g,'S')
      .replace(/[0Ｏ]/g,'O');
    // Aceptar I(D|O)ESP al inicio
    return /^I[DO]ESP/.test(norm);
  }
  let Nacionalidad = "";
  if (MRZ_L1 && isSpainFromL1(MRZ_L1)) {
    Nacionalidad = "España";
  }

  /* ---- Nº de documento desde L1: 9 previos al primer "<<<" ---- */
  function docFromL1(l1){
    const m = l1.match(/<{3,}/);
    if(!m) return "";
    const idx = m.index;
    if(idx < 9) return "";
    const cand = l1.slice(idx-9, idx);
    return /^[0-9]{8}[A-Z]$/.test(cand) ? cand : "";
  }
  const numDoc = MRZ_L1 ? docFromL1(MRZ_L1) : "";

 /* ---- Fecha, Sexo y Nacionalidad desde L2 ---- */
let fechaNac = "";
let sexo = "";
{
  // L2 típico: YY MM DD (check) SEX EXPYY EXPMM EXPDD (check) NAT...
  // Ej.: 8001014F2501017ESP<<<<<<<<<<<7
  const m = MRZ_L2.match(
    /^(\d{2})(\d{2})(\d{2})\d([MF])(\d{2})(\d{2})(\d{2})\d([A-Z]{3})/
  );
  if (m) {
    const yy = parseInt(m[1], 10), mm = m[2], dd = m[3];
    const year = yy >= 30 ? 1900 + yy : 2000 + yy;
    fechaNac = `${dd}/${mm}/${year}`;
    sexo = m[4] === "F" ? "FEMENINO" : "MASCULINO";

    // Nacionalidad desde L2 si aún no la tenemos
    const nat3 = m[8];
    if (!Nacionalidad) {
      Nacionalidad = nat3 === "ESP" ? "España" : nat3;
    }
  }
}

  /* ---- Nombres y apellidos desde L3 ---- */
  let nombre = "", apellidos = "";
  if(MRZ_L3){
    const parts = MRZ_L3.split("<").filter(Boolean);
    const ap1 = parts[0] || "";
    const ap2 = parts[1] || "";
    const nom1 = parts[2] || "";
    const nom2 = parts[3] || "";
    apellidos = [ap1, ap2].filter(Boolean).join(" ").trim();
    nombre = [nom1, nom2].filter(Boolean).join(" ").trim();
    apellidos = apellidos.toUpperCase();
    nombre = tcase(nombre);
  }

  /* ---- Tipo de documento (reverso DNI) ---- */
  let tipo = "DNI";

  return {
    Nombre: nombre,
    Apellidos: apellidos,
    "Tipo de documento": tipo,
    "Nº Documento": numDoc,
    Sexo: sexo,
    Nacionalidad: Nacionalidad,
    "Nombre de los Padres": padres,
    "Fecha de nacimiento": fechaNac,
    "Lugar de nacimiento": lugarNac,
    Domicilio: domicilio
  };
}

/* ========= Validación visual / filename ========= */
function validateAll(){
  ["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"]
    .forEach(id=>{
      const el=document.getElementById(id);
      const ok=!!(el.value&&el.value.trim());
      el.classList.toggle("valid",ok);
      el.classList.toggle("invalid",!ok);
    });
}
function updateFilename(){
  const ap=(document.getElementById('Apellidos').value||"APELLIDOS").trim();
  document.getElementById('fname').textContent = ap + ".json";
}

/* ========= Núcleo: leer → aplicar reglas → rellenar ========= */
function fillFormFromParsed(p){
  if(p.Nombre)  document.getElementById('Nombre').value = p.Nombre;
  if(p.Apellidos) document.getElementById('Apellidos').value = p.Apellidos;
  if(p["Tipo de documento"]) document.getElementById('Tipo').value = p["Tipo de documento"];
  if(p["Nº Documento"]) document.getElementById('Numero').value = p["Nº Documento"];
  if(p.Sexo) document.getElementById('Sexo').value = p.Sexo;
  if(p.Nacionalidad) document.getElementById('Nacionalidad').value = p.Nacionalidad;
  if(p["Nombre de los Padres"]) document.getElementById('Padres').value = p["Nombre de los Padres"];
  if(p["Fecha de nacimiento"]) document.getElementById('Nacimiento').value = p["Fecha de nacimiento"];
  if(p["Lugar de nacimiento"]) document.getElementById('Lugar').value = p["Lugar de nacimiento"];
  if(p.Domicilio) document.getElementById('Domicilio').value = p.Domicilio;

  updateFilename();
  validateAll();
}

function processOCR(ocr){
  if(!ocr.trim()){ alert("Portapapeles vacío. Copia el OCR primero."); return; }
  // Aplicar exactamente tus reglas al OCR bruto
  const parsed = parseByRules(ocr);
  fillFormFromParsed(parsed);
}

/* ========= Botones ========= */
document.getElementById('readAnalyze').addEventListener('click', async ()=>{
  const ocr = await readFromClipboard();
  processOCR(ocr);
});
document.getElementById('clear').addEventListener('click', ()=>{
  ["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"]
    .forEach(id=>document.getElementById(id).value="");
  updateFilename(); validateAll();
});
document.getElementById('Apellidos').addEventListener('input', updateFilename);

/* ========= Descargar JSON ========= */
document.getElementById('download').addEventListener('click', ()=>{
  if(!document.getElementById('Condicion').value){
    alert("Condición obligatoria");
    document.getElementById('Condicion').classList.add('invalid');
    return;
  }
  const data={
    "Nombre": document.getElementById('Nombre').value,
    "Apellidos": (document.getElementById('Apellidos').value||"").toUpperCase(),
    "Tipo de documento": document.getElementById('Tipo').value,
    "Nº Documento": document.getElementById('Numero').value,
    "Sexo": document.getElementById('Sexo').value,
    "Nacionalidad": document.getElementById('Nacionalidad').value,
    "Nombre de los Padres": document.getElementById('Padres').value,
    "Fecha de nacimiento": document.getElementById('Nacimiento').value,
    "Lugar de nacimiento": document.getElementById('Lugar').value,
    "Domicilio": document.getElementById('Domicilio').value,
    "Teléfono": document.getElementById('Telefono').value,
    "Condición": document.getElementById('Condicion').value
  };
  const fname=(document.getElementById('Apellidos').value||"APELLIDOS") + ".json";
  const a=document.createElement('a');
  a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data,null,2));
  a.download=fname; a.click();
});
/* ========= Foto IA en pestaña nueva ========= */
document.getElementById("openIA").addEventListener("click", ()=>{
  const url = "https://chatgpt.com/g/g-68fe060630348191b62c44416164a37d-filiaciones-ocr-docu";
  window.open(url, "_blank", "noopener");
});
/* ========= Estado inicial ========= */
updateFilename();
validateAll();
</script>

</body>
</html>
