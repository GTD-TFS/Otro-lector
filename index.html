<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCR DNI - Preprocesado mejorado</title>
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 1rem; background: #f6f7f9; color: #111; }
    .app { max-width: 760px; margin: 0 auto; background: #fff; border-radius: 12px;
           padding: 1rem; box-shadow: 0 6px 30px rgba(0,0,0,.06); }
    h1 { font-size: 1.25rem; margin-bottom: 1rem; }
    .row { display: flex; flex-wrap: wrap; gap: .5rem; align-items: center; margin-bottom: .75rem; }
    label { font-weight: 600; }
    input[type="file"], select, button, textarea {
      padding: .6rem .7rem; border: 1px solid #dfe3e6; border-radius: 10px; background: #fff; font-size: 1rem;
    }
    button.primary { background: #111; color: #fff; border: none; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .preview { width: 100%; max-height: 320px; object-fit: contain; border-radius: 10px; background: #f0f2f5; }
    textarea { width: 100%; min-height: 200px; resize: vertical; }
  </style>
</head>
<body>
  <div class="app">
    <h1>OCR DNI (anverso) ‚Äì versi√≥n mejorada</h1>

    <!-- Entrada -->
    <div class="row">
      <button id="fotoBtn" type="button" class="primary">üì∏ Hacer foto</button>
      <input id="fotoInput" type="file" accept="image/*" capture="environment" hidden>

      <button id="archivoBtn" type="button">üìÅ Elegir archivo</button>
      <input id="archivoInput" type="file" accept="image/*" hidden>
    </div>

    <!-- Idioma -->
    <div class="row">
      <label for="lang">Idioma del texto</label>
      <select id="lang">
        <option value="spa" selected>Espa√±ol</option>
        <option value="eng">Ingl√©s</option>
      </select>
      <button id="run" class="primary" type="button">Leer texto</button>
      <button id="clear" type="button">Limpiar</button>
    </div>

    <img id="preview" class="preview" alt="Vista previa" />

    <div class="row" style="flex-direction:column; align-items:stretch;">
      <label for="output">Texto detectado y campos extra√≠dos</label>
      <textarea id="output" placeholder="Aqu√≠ aparecer√° el texto reconocido‚Ä¶"></textarea>
    </div>
  </div>

  <!-- Tesseract.js -->
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    const fotoBtn = $('fotoBtn'), fotoInput = $('fotoInput');
    const archivoBtn = $('archivoBtn'), archivoInput = $('archivoInput');
    const runBtn = $('run'), clearBtn = $('clear');
    const preview = $('preview'), output = $('output'), langSel = $('lang');
    let currentBlob = null;

    fotoBtn.addEventListener('click', () => fotoInput.click());
    archivoBtn.addEventListener('click', () => archivoInput.click());

    fotoInput.addEventListener('change', () => onPick(fotoInput.files?.[0], 'Foto cargada.'));
    archivoInput.addEventListener('change', () => onPick(archivoInput.files?.[0], 'Archivo cargado.'));

    function onPick(file, msg){
      if (!file) return;
      currentBlob = file;
      preview.src = URL.createObjectURL(file);
      output.value = msg + "\n";
    }

    clearBtn.addEventListener('click', () => {
      currentBlob = null;
      fotoInput.value = '';
      archivoInput.value = '';
      preview.removeAttribute('src');
      output.value = '';
    });

    // === PREPROCESAMIENTO DE IMAGEN ===
    async function preprocessImage(blob) {
      return new Promise((resolve) => {
        const img = new Image();
        const url = URL.createObjectURL(blob);
        img.onload = () => {
          const scale = 2.5; // Aumenta resoluci√≥n
          const canvas = document.createElement("canvas");
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext("2d");

          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;

          // Convertir a blanco y negro (contraste alto)
          for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            const val = avg < 128 ? 0 : 255;
            data[i] = data[i + 1] = data[i + 2] = val;
          }
          ctx.putImageData(imageData, 0, 0);
          canvas.toBlob((b) => resolve(b), "image/png");
        };
        img.src = url;
      });
    }

    runBtn.addEventListener('click', async () => {
      if (!currentBlob) return alert('Selecciona o haz una foto primero.');
      const lang = langSel.value || 'spa';
      output.value = 'Procesando imagen y reconociendo texto‚Ä¶';

      try {
        const worker = await Tesseract.createWorker(lang, 1, {
          workerPath: 'https://unpkg.com/tesseract.js@5.1.0/dist/worker.min.js',
          corePath: 'https://unpkg.com/tesseract.js-core@5.0.0/tesseract-core.wasm.js'
        });

        await worker.setParameters({ tessedit_pageseg_mode: 6 });

        // üîç Preprocesar imagen antes del OCR
        const preprocessed = await preprocessImage(currentBlob);

        const { data } = await worker.recognize(preprocessed);
        const texto = data.text.trim();
        const parsed = parseDNI(texto);

        output.value = texto + '\n\n--- Campos (DNI anverso) ---\n' + JSON.stringify(parsed, null, 2);
        await worker.terminate();
      } catch (err) {
        output.value = 'Error: ' + err.message;
      }
    });

    // ====== Parser simple desde texto crudo ======
    function norm(s){
      return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'')
               .replace(/[^\p{L}\p{N}\n\s:/.-]/gu,' ')
               .replace(/\s+/g,' ')
               .trim().toUpperCase();
    }
    function splitLines(raw){
      return (raw||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    }

    function parseDNI(raw){
      const out = {
        "Nombre": "",
        "APELLIDOS": "",
        "TIPO DOCUMENTO": "DNI",
        "N¬∫DOCUMENTO": "",
        "SEXO": "",
        "NACIONALIDAD": "",
        "Nombre de los Padres": "",
        "FECHA DE NACIMIENTO": "",
        "LUGAR DE NACIMIENTO": "",
        "DOMICILIO": ""
      };

      const rawLines = splitLines(raw);
      const lines = splitLines(norm(raw));

      const nextLine = (L,i)=> L.slice(i+1).find(x=>x && x.length>0) || "";
      const nextTwo  = (L,i)=> L.slice(i+1).filter(x=>x && x.length>0).slice(0,2);

      // APELLIDOS
      {
        const idx = lines.findIndex(l => /\bAPELLIDOS\b/.test(l));
        if (idx >= 0) {
          const [l1,l2] = nextTwo(lines, idx);
          const ap = [l1,l2].filter(Boolean).join(' ').replace(/[^A-Z '\-]/g,' ').replace(/\s+/g,' ').trim();
          if (ap) out["APELLIDOS"] = ap;
        }
      }

      // NOMBRE
      {
        const idx = lines.findIndex(l => /\bNOMBRE\b/.test(l));
        if (idx >= 0) {
          const l = nextLine(rawLines, idx) || nextLine(lines, idx);
          const nom = (l||'').replace(/[^A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√± '\-]/g,' ').replace(/\s+/g,' ').trim();
          if (nom) out["Nombre"] = nom;
        }
      }

      // SEXO
      {
        const idx = lines.findIndex(l => /\bSEXO\b/.test(l));
        let sex = '';
        if (idx >= 0) {
          const l = nextLine(lines, idx);
          sex = (l.match(/\b[MF]\b/)||[])[0] || '';
        }
        if (!sex) sex = (norm(raw).match(/\b[MF]\b/)||[])[0] || '';
        if (sex) out["SEXO"] = sex;
      }

      // NACIONALIDAD
      {
        const idx = lines.findIndex(l => /\bNACIONALIDAD\b/.test(l));
        let val = '';
        if (idx >= 0) {
          const l = nextLine(lines, idx);
          val = (l.match(/\b[A-Z]{2,4}\b/)||[])[0] || '';
        }
        if (!val) {
          val = /\bESP\b/.test(norm(raw)) ? 'ESP' : (norm(raw).match(/\b[A-Z]{2,4}\b/)||[])[0] || '';
          if (val === 'DNI') val = '';
        }
        if (val) out["NACIONALIDAD"] = val;
      }

      // FECHA NACIMIENTO
      {
        const m = raw.match(/\b(\d{1,2})[\/.\-\s](\d{1,2})[\/.\-\s](\d{2,4})\b/);
        if (m) {
          const dd = m[1].padStart(2,'0'), mm = m[2].padStart(2,'0');
          const yy = m[3].length===2 ? ('19'+m[3]) : m[3];
          out["FECHA DE NACIMIENTO"] = `${dd}/${mm}/${yy}`;
        }
      }

      // N¬∫ DOCUMENTO
      {
        const m = norm(raw).match(/\b\d{8}[ -]?[A-Z]\b/);
        if (m) out["N¬∫DOCUMENTO"] = m[0].replace(/[ -]/g,'');
      }

      return out;
    }
  </script>
</body>
</html>
