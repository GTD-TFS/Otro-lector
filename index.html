<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCR DNI - con estructura</title>
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 1rem; background: #f6f7f9; color: #111; }
    .app { max-width: 760px; margin: 0 auto; background: #fff; border-radius: 12px;
           padding: 1rem; box-shadow: 0 6px 30px rgba(0,0,0,.06); }
    h1 { font-size: 1.25rem; margin-bottom: 1rem; }
    .row { display: flex; flex-wrap: wrap; gap: .5rem; align-items: center; margin-bottom: .75rem; }
    label { font-weight: 600; }
    input[type="file"], select, button, textarea {
      padding: .6rem .7rem; border: 1px solid #dfe3e6; border-radius: 10px; background: #fff; font-size: 1rem;
    }
    button.primary { color: #fff; border: none; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .preview { width: 100%; max-height: 320px; object-fit: contain; border-radius: 10px; background: #f0f2f5; }
    textarea { width: 100%; min-height: 180px; resize: vertical; }
    pre { background: #f7f7f7; border-radius: 8px; padding: .7rem; overflow-x: auto; }
  </style>
</head>
<body>
  <div class="app">
    <h1>OCR DNI ‚Äì anverso + estructura</h1>

    <!-- Entrada -->
    <div class="row">
      <button id="fotoBtn" type="button">üì∏ Hacer foto</button>
      <input id="fotoInput" type="file" accept="image/*" capture="environment" hidden>
      <button id="archivoBtn" type="button">üìÅ Elegir archivo</button>
      <input id="archivoInput" type="file" accept="image/*" hidden>
    </div>

    <!-- Idioma -->
    <div class="row">
      <label for="lang">Idioma</label>
      <select id="lang">
        <option value="spa" selected>Espa√±ol</option>
        <option value="eng">Ingl√©s</option>
      </select>

      <!-- Bot√≥n con color distinto en esta versi√≥n -->
      <button id="run" class="primary" type="button" style="background:#d35400;">Leer texto</button>
      <button id="clear" type="button">Limpiar</button>
    </div>

    <img id="preview" class="preview" alt="Vista previa" />

    <!-- Resultados -->
    <div class="row" style="flex-direction:column; align-items:stretch;">
      <label for="output">Texto detectado y campos extra√≠dos</label>
      <textarea id="output" placeholder="Aqu√≠ aparecer√° el texto reconocido‚Ä¶"></textarea>
    </div>

    <!-- Estructura OCR -->
    <div class="row" style="flex-direction:column; align-items:stretch;">
      <div class="row" style="justify-content:space-between; padding:0;">
        <label>Estructura OCR (l√≠neas y coordenadas)</label>
        <button id="toggleStruct" type="button">Mostrar/Ocultar</button>
      </div>
      <pre id="structure" style="display:none;"></pre>
    </div>
  </div>

  <!-- Tesseract.js -->
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    const fotoBtn = $('fotoBtn'), fotoInput = $('fotoInput');
    const archivoBtn = $('archivoBtn'), archivoInput = $('archivoInput');
    const runBtn = $('run'), clearBtn = $('clear');
    const preview = $('preview'), output = $('output'), langSel = $('lang');
    const toggleStructBtn = $('toggleStruct'), structure = $('structure');
    let currentBlob = null;
    let lastData = null;

    fotoBtn.addEventListener('click', () => fotoInput.click());
    archivoBtn.addEventListener('click', () => archivoInput.click());

    fotoInput.addEventListener('change', () => onPick(fotoInput.files?.[0]));
    archivoInput.addEventListener('change', () => onPick(archivoInput.files?.[0]));

    function onPick(file){
      if (!file) return;
      currentBlob = file;
      preview.src = URL.createObjectURL(file);
      output.value = '';
      structure.textContent = '';
      structure.style.display = 'none';
    }

    clearBtn.addEventListener('click', () => {
      currentBlob = null; lastData = null;
      fotoInput.value=''; archivoInput.value='';
      preview.removeAttribute('src'); output.value='';
      structure.textContent=''; structure.style.display='none';
    });

    toggleStructBtn.addEventListener('click', () => {
      if (!lastData) { alert('Primero pulsa "Leer texto"'); return; }
      structure.style.display = structure.style.display==='none' ? '' : 'none';
    });

    runBtn.addEventListener('click', async () => {
      if (!currentBlob) return alert('Selecciona o haz una foto primero.');
      output.value = 'Reconociendo‚Ä¶';

      try {
        const worker = await Tesseract.createWorker(langSel.value || 'spa', 1, {
          workerPath: 'https://unpkg.com/tesseract.js@5.1.0/dist/worker.min.js',
          corePath: 'https://unpkg.com/tesseract.js-core@5.0.0/tesseract-core.wasm.js'
        });

        await worker.setParameters({ tessedit_pageseg_mode: 6 });
        const { data } = await worker.recognize(currentBlob);
        lastData = data;

        const texto = data.text.trim();
        const parsed = parseDNI(texto);
        output.value = texto + '\n\n--- Campos ---\n' + JSON.stringify(parsed, null, 2);

        renderStructure(data);
        await worker.terminate();
      } catch (err) {
        output.value = 'Error: ' + err.message;
      }
    });

    // === Estructura OCR: agrupar palabras en l√≠neas por Y ===
    function renderStructure(data){
      const words = (data.words||[]).filter(w=>w.text.trim());
      words.sort((a,b)=>a.bbox.y0-b.bbox.y0 || a.bbox.x0-b.bbox.x0);

      const tolY=8, rows=[];
      for (const w of words){
        const y=w.bbox.y0;
        const r=rows.find(rr=>Math.abs(rr.y-y)<=tolY);
        if(r){r.items.push(w); r.y=(r.y+y)/2;}
        else rows.push({y,items:[w]});
      }
      for(const r of rows) r.items.sort((a,b)=>a.bbox.x0-b.bbox.x0);

      const lines=rows.sort((a,b)=>a.y-b.y)
        .map((r,i)=>`${String(i+1).padStart(2,'0')} | y‚âà${Math.round(r.y)} | ${r.items.map(it=>it.text).join(' ')}`);
      structure.textContent = lines.join('\\n');
    }

    // === Parser b√°sico de DNI ===
    function norm(s){
      return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'')
        .replace(/[^\p{L}\p{N}\n\s:/.-]/gu,' ')
        .replace(/\s+/g,' ').trim().toUpperCase();
    }
    function splitLines(raw){ return (raw||'').split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean); }

    function parseDNI(raw){
      const out = {
        "Nombre": "", "APELLIDOS": "", "TIPO DOCUMENTO": "DNI",
        "N¬∫DOCUMENTO": "", "SEXO": "", "NACIONALIDAD": "",
        "Nombre de los Padres": "", "FECHA DE NACIMIENTO": "",
        "LUGAR DE NACIMIENTO": "", "DOMICILIO": ""
      };
      const rawLines=splitLines(raw), lines=splitLines(norm(raw));
      const nextLine=(L,i)=>L.slice(i+1).find(x=>x)||"", nextTwo=(L,i)=>L.slice(i+1).filter(x=>x).slice(0,2);

      const idxAp=lines.findIndex(l=>/\\bAPELLIDOS\\b/.test(l));
      if(idxAp>=0){const [l1,l2]=nextTwo(lines,idxAp);out["APELLIDOS"]=[l1,l2].filter(Boolean).join(' ');}
      const idxNom=lines.findIndex(l=>/\\bNOMBRE\\b/.test(l));
      if(idxNom>=0){const l=nextLine(rawLines,idxNom)||nextLine(lines,idxNom);out["Nombre"]=l;}
      const mFecha=raw.match(/\\b(\\d{1,2})[\\/\\.\\-\\s](\\d{1,2})[\\/\\.\\-\\s](\\d{2,4})\\b/);
      if(mFecha){out["FECHA DE NACIMIENTO"]=`${mFecha[1].padStart(2,'0')}/${mFecha[2].padStart(2,'0')}/${mFecha[3].length===2?'19'+mFecha[3]:mFecha[3]}`;}
      const mDoc=norm(raw).match(/\\b\\d{8}[ -]?[A-Z]\\b/);if(mDoc) out["N¬∫DOCUMENTO"]=mDoc[0].replace(/[ -]/g,'');
      return out;
    }
  </script>
</body>
</html>
